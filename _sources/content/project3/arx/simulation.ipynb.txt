{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "cc66f82b-c67b-4713-bd63-ffba461b2876",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "pygame 2.6.1 (SDL 2.28.4, Python 3.12.4)\n",
      "Hello from the pygame community. https://www.pygame.org/contribute.html\n"
     ]
    }
   ],
   "source": [
    "import numpy as np\n",
    "import pygame\n",
    "from pygame.locals import QUIT, MOUSEBUTTONDOWN, KEYDOWN\n",
    "import sys\n",
    "import math\n",
    "import matplotlib.pyplot as plt\n",
    "from PyQt5.QtWidgets import QApplication, QMainWindow\n",
    "from PyQt5.QtCore import Qt\n",
    "from matplotlib.backends.backend_qt5agg import FigureCanvasQTAgg as FigureCanvas\n",
    "import pygetwindow as gw\n",
    "import pyaudio\n",
    "import threading\n",
    "import control\n",
    "import param"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "d647a07c-6cb8-4a22-be75-91e62f2ebdd3",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Extracting constants from param module\n",
    "L1, L2, m1, m2, I1, I2, g, dp, wheelradius = param.L1, param.L2, param.m1, param.m2, param.I1, param.I2, param.g, param.dp, param.wheelradius\n",
    "J, Ng, ke, kt, R, L, B = param.J, param.Ng, param.ke, param.kt, param.R, param.L, param.B\n",
    "Q_LQR, R_LQR, N_LQR = param.Q_LQR, param.R_LQR, param.N_LQR\n",
    "StabilizeBound = param.StabilizeBound"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "2e05377f-e7d6-45bd-9134-77f921f478d7",
   "metadata": {},
   "outputs": [],
   "source": [
    "# LQR (linear quadratic regulator) controller parameter\n",
    "a = (m1 * L1 * L1) + (m2 * L2 * L2) + (I1)\n",
    "b = (m1 * L1 + m2 * L2) * g\n",
    "\n",
    "a21 = b/a\n",
    "a24 = (kt * ke * Ng * Ng)/(a * R)\n",
    "a41 = -b/a\n",
    "a44 = -(a + J) * (kt * ke * Ng * Ng) /(a * J * R)\n",
    "\n",
    "b2 = -(kt*Ng)/(a*R)\n",
    "b4 = (a + J) * (kt * Ng)/(a * J * R)\n",
    "\n",
    "A_matrix = np.array([[0, 1, 0, 0],\n",
    "                     [a21, 0, 0, a24],\n",
    "                     [0, 0, 0, 1],\n",
    "                     [a41, 0, 0 , a44]])\n",
    "\n",
    "B_Matrix = np.array([[0],\n",
    "                     [b2],\n",
    "                     [0],\n",
    "                     [b4]])\n",
    "\n",
    "desired_poles = []"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "05db12c9-60bd-4d80-a639-d119f91d3cf1",
   "metadata": {},
   "outputs": [],
   "source": [
    "# ==========================================================================================\n",
    "# ======================================= FUNCTION =========================================\n",
    "# ==========================================================================================\n",
    "def Forwardkinematics(q):\n",
    "    x = L2 * math.sin(q)\n",
    "    y = L2 * math.cos(q)\n",
    "    return x, y\n",
    "\n",
    "def PendulumEnergy(q):\n",
    "    K = (\n",
    "        (0.5 * m1 * math.pow(qp_d * L1, 2))\n",
    "        + (0.5 * m2 * math.pow(qp_d * L2, 2))\n",
    "        + (0.5 * J * qp_d * qp_d)\n",
    "        + (0.5 * I1 * qp_d * qp_d)\n",
    "    )  # Kinetic energy\n",
    "    P = (m1 + m2) * g * L2 * math.cos(q)  # Potential energy\n",
    "    return K + P\n",
    "\n",
    "def MotorDynamics(Vin, dt):\n",
    "    global qr_d, qr, curr_prev, curr_d\n",
    "    curr = (Vin - (qr_d * ke) - (L * curr_d)) / R\n",
    "    curr_d = (curr - curr_prev)/dt\n",
    "    Tm = curr * kt\n",
    "    qr_dd = (Tm - B * qr_d) / J\n",
    "    qr_d = qr_d + (qr_dd * dt)\n",
    "    qr = qr + (qr_d * dt)\n",
    "    curr_prev = curr\n",
    "    return Tm\n",
    "\n",
    "\n",
    "def RwipDynamics(q, Tr, Tp):\n",
    "    qdd = (\n",
    "        (m1 * g * L1 * math.sin(q)) + (m2 * g * L2 * math.sin(q)) - Tr + Tp - dp * qp_d\n",
    "    ) / ((m1 * L1**2.0) + (m2 * L2) + I1)\n",
    "    return qdd"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "e16feeae-f42e-4838-9cdf-23652303a323",
   "metadata": {},
   "outputs": [],
   "source": [
    "def plot_figure(screen, qp, qp_d, qr_d, Tm, Vin, Tp, setpoint):\n",
    "    x_offset = 200\n",
    "    y_offset = 360\n",
    "    multiplier = 800\n",
    "\n",
    "    # Draw RWIP\n",
    "    x, y = Forwardkinematics(qp)\n",
    "    x, y = x_offset - x * multiplier, y_offset - y * multiplier\n",
    "    pygame.draw.line(screen, BLACK, (x_offset, y_offset), (x, y), 5)\n",
    "\n",
    "    # Draw wheel\n",
    "    pygame.draw.circle(screen, GREY, (x, y), wheelradius * multiplier, 8)\n",
    "\n",
    "    # Draw cross\n",
    "    cross_length = wheelradius * multiplier\n",
    "    cross_dx = cross_length * np.sin(qr) * 0.8\n",
    "    cross_dy = -cross_length * np.cos(qr) * 0.8\n",
    "    pygame.draw.line(\n",
    "        screen, BLACK, (x - cross_dx, y - cross_dy), (x + cross_dx, y + cross_dy), 2\n",
    "    )\n",
    "    pygame.draw.line(\n",
    "        screen, BLACK, (x - cross_dy, y + cross_dx), (x + cross_dy, y - cross_dx), 2\n",
    "    )\n",
    "\n",
    "    # Draw pendulum point\n",
    "    pygame.draw.circle(screen, BLACK, (x, y), 5)\n",
    "    pygame.draw.circle(screen, BLACK, (x_offset, y_offset), 5)\n",
    "\n",
    "    # Draw text\n",
    "    font = pygame.font.Font(None, 18)\n",
    "    texts = [\n",
    "        f\"Setpoint (deg): {round(np.rad2deg(setpoint), 2)}\",\n",
    "        f\"Pendulum Angle (deg): {round(np.rad2deg(qp), 2)}\",\n",
    "        f\"Pendulum Speed (deg/s) : {round(np.rad2deg(qp_d), 2)}\",\n",
    "        f\"Controller Mode : {controller_mode}\",\n",
    "    ]\n",
    "    for i, text in enumerate(texts):\n",
    "        rendered_text = font.render(text, True, WHITE)\n",
    "        screen.blit(rendered_text, (10, 80 + i * 20))\n",
    "    \n",
    "    texts = [\n",
    "        f\"Motorspeed (RPM): {round(qr_d * 60 / (math.pi * 2), 2)}\",\n",
    "        f\"Apply Torque (Nm): {round(Tm, 2)}\",\n",
    "        f\"Vin (V): {round(Vin, 2)}\",\n",
    "    ]\n",
    "    for i, text in enumerate(texts):\n",
    "        rendered_text = font.render(text, True, WHITE)\n",
    "        screen.blit(rendered_text, (230, 80 + i * 20))\n",
    "\n",
    "    texts = [\n",
    "        f\"FUEL: {round(controller_energy, 2)}\",\n",
    "        f\"TIME: {round(controller_time, 2)}\",\n",
    "    ]\n",
    "    for i, text in enumerate(texts):\n",
    "        rendered_text = font.render(text, True, BLACK)\n",
    "        screen.blit(rendered_text, (10, 170 + i * 20))\n",
    "\n",
    "\n",
    "def plot_graph():\n",
    "    plt.clf()\n",
    "\n",
    "    # Create the first subplot\n",
    "    plt.subplot(2, 1, 1)\n",
    "    plt.plot(timedt_data, qp_data, label=\"qp\", color=\"blue\", linewidth=2)\n",
    "    plt.plot(timedt_data, setpoint_data, label=\"setpoint\", color=\"red\", linewidth=2)\n",
    "    plt.legend()\n",
    "\n",
    "    # Create the second subplot\n",
    "    plt.subplot(2, 1, 2)\n",
    "    plt.plot(timedt_data, qr_d_data, label=\"qr_d\", color=\"purple\", linewidth=2)\n",
    "    plt.legend(loc=\"upper left\")\n",
    "    ax2 = plt.twinx()\n",
    "    ax2.plot(timedt_data, Tm_data, label=\"Tm\", color=\"green\", linewidth=2)\n",
    "    ax2.set_ylim(-1, 1)\n",
    "    ax2.legend(loc=\"upper right\")\n",
    "\n",
    "    # Display the figure\n",
    "    canvas = FigureCanvas(fig)\n",
    "    win.setCentralWidget(canvas)\n",
    "    win.show()\n",
    "\n",
    "def on_click(event):\n",
    "    plot_graph()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "753b7586-158e-4068-b52f-cc953b89773c",
   "metadata": {},
   "outputs": [],
   "source": [
    "# ==========================================================================================\n",
    "# ========================================= EXTRA ==========================================\n",
    "# ==========================================================================================\n",
    "\n",
    "p = pyaudio.PyAudio()\n",
    "BITRATE = 90000  # number of frames per second/frameset.\n",
    "FREQUENCY = 2000  # Hz, waves per second, 261.63=C4-note.\n",
    "BITRATE = max(BITRATE, FREQUENCY + 100)\n",
    "stream = p.open(format=p.get_format_from_width(1), channels=1, rate=BITRATE, output=True)\n",
    "stop_thread = False\n",
    "\n",
    "def generate_sound():\n",
    "    \"\"\"Generate and play sound with current frequency in a loop.\"\"\"\n",
    "    while not stop_thread:\n",
    "        # Generate wave data for 1 second\n",
    "        NUMBEROFFRAMES = int(BITRATE * 0.0002)  # 1 second of sound\n",
    "        WAVEDATA = \"\"\n",
    "        for x in range(NUMBEROFFRAMES):\n",
    "            try:\n",
    "                WAVEDATA += chr(int(math.sin(x / ((BITRATE / FREQUENCY) / math.pi)) * 127 + 128))\n",
    "            except ZeroDivisionError:\n",
    "                WAVEDATA += chr(128)\n",
    "        # Play sound\n",
    "        stream.write(WAVEDATA)\n",
    "\n",
    "# Start sound generation in a separate thread\n",
    "sound_thread = threading.Thread(target=generate_sound)\n",
    "if param.Sound:\n",
    "    sound_thread.start()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "bc19e27e-5ad7-4f23-bb4d-875fa2f5e6ad",
   "metadata": {},
   "outputs": [
    {
     "ename": "SystemExit",
     "evalue": "",
     "output_type": "error",
     "traceback": [
      "An exception has occurred, use %tb to see the full traceback.\n",
      "\u001b[1;31mSystemExit\u001b[0m\n"
     ]
    },
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "C:\\Users\\Utilizador\\anaconda3\\Lib\\site-packages\\IPython\\core\\interactiveshell.py:3585: UserWarning: To exit: use 'exit', 'quit', or Ctrl-D.\n",
      "  warn(\"To exit: use 'exit', 'quit', or Ctrl-D.\", stacklevel=1)\n"
     ]
    },
    {
     "data": {
      "image/png": "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GqRq1aqpcuXK6tWrl/73f/9XklRQUKApU6YoIyNDMTExql+/vv7zP/8zpH4Vl5+fr4kTJyotLU0xMTFq1KiR/vrXv5Z4nJZ078XM9Oabb6pTp06qXr26YmJiVLt2bV1xxRV6/vnnSxyXf/zjH+rYsaPi4+N14YUXKisrSxs2bAi5/wcPHtR//Md/qGfPnr5zLTExUVdddZU+/PDDgPWbNm0qj8ejTZs2Ba1v+/btCgsLU4MGDUo9V73n+qJFiyRJF110kd85WtyxY8f08MMPq2nTpoqNjVWVKlXUqVMnvfnmmyHvp+Q/9nv37lVeXp5SUlIUGxurli1blnpcl+SLL75Q//79lZSUpOjoaKWnp+uWW27Rd99957deea9H5Wbl8Mc//tEk2R133FGezczMbNKkSSbJpk+f7leem5trkmzhwoV+5d999501btzYJFnVqlWtX79+du2111pmZqZ5PB6/eoLV/fPPP9v1119vkqx379527NixkPq5du1aq1atmkmyRo0a2ZAhQ6x9+/YmySIiImz27Nl+62/bts0kWbt27axjx4524YUXWs+ePa1nz54WExNjkuy+++4Lqe1HH33UOnToYJIsMzPTcnNzfX+LFy82M7OFCxeaJOvfv79lZGRYSkqK9e3b17p27Wrh4eEmyV566aWAuhcvXmyVK1c2SdakSRMbOHCgtWvXzjwej8XGxtonn3wSUh/NzDp37mySbMyYMebxeKxTp042ZMgQS09PN0lWq1Yt27VrV8B248aNM0kWExNjnTp1sqysLKtTp45JslatWtnRo0eDtjN+/HgLCwuztm3bWlZWltWuXdskWYMGDQJe1/3791tGRoavH4MHD7bOnTtbWFiY3XLLLSbJOnfu7LdNSceglySrU6eOX5n3dcjNzf3FdU2fPt0k2Q033GBVq1a1unXrWlZWljVr1swkWVJSku3du9f69+9vCQkJduWVV1rPnj0tKirKJNmLL74YtK1gTpw44Tueq1WrZgMHDrSePXtaZGSkb3xC3deJEyeaJEtISLBevXpZTk6OdenSxapVqxZQh3dcbrnlFvN4PNamTRsbMmSI7xyvUqWKrV69OqR2//GPf5gkq127tnXv3t0GDx7sO5Y9Ho9NmzbNb/1nn33WdxwFc//995ske+yxx0odu3379llubq6lpKSYJLv22mv9zlGvw4cP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RYMGDdKsWbPK3bdQ3HTTTVqzZo2ysrI0ceJENWzYUAkJCQoLC9OLL76okSNHBq1v5MiRGjVqlF5++WU99NBDmj59ugoKCjRixIigwf5LhDKW5+sXCM7m+nYulCt8evfureeff15vvfWWHn/88YCvCCpK7dq1JUnffvttubbr1auXhg0bpoEDB+rqq6/WggUL1K5du5C3r1mzpiRp27ZtQZd738H/u81LqlWrljZu3Kj7779fl1xySYXVu2PHjqD1eX9ayTue3k8u1atXP6c/geRtr6TH8M/8ySevqKgoSQr6uHcoc9XOVV0VrazxCWX6wpkqV66soUOHaujQoZJO//pJdna2Zs+erby8PPXq1SukNs48ZkqSn5+vDz/8UCkpKZo9e3bA1+Nbt24tcdthw4Zp/Pjxevnll/XAAw9o2rRpCgsL04033ljmfoaqrGvIoUOHdOjQIVWqVEkJCQkh11vWa1bWuHnX2bhxo7Zt2xb0FoHr61u54v6qq65SkyZNtHv3bv35z38udd3Dhw/rn//851l16oorrpAkvf766zp27Fi5tu3Xr59mz56tEydO6KqrrtKXX34Z8raXX365JGnWrFm+d+vFvfbaa37rnQvei1dBQUGF1ekdz7lz51ZYnZKCvrM9cOCAPvjgA3k8Hl/w16pVSw0bNtTatWtLPCkrQqtWrRQTE6Mvv/wy6IW+pDkW3pMt2DyQDz74oFx9qMi6KlqdOnVUq1Yt7dmzR1988UXA8vLOQQnmsssu893X+OabbwKWBztmCgoKNGfOHElShw4dSq3/0KFDKioqUo0aNQKCp6CgQO+8806J28bHx2vo0KHavXu3xo8fr61bt6pXr14lfoVdktLO0VatWik2NlbLly8Pev/Sew3p2LFjuT5hrF69Ougx9cYbb0gqe9yk/7tuvf766wHLTp06pbfeestvPencXI+8yhU+Ho9Hr732mmJiYjR58mTdc889ys/P91vHzPTuu++qdevW5b6B7dW2bVt17dpV33//vUaOHBkQQN9++22pk9IGDBigN998U8eOHVPPnj319ddfh9Ruly5d1KxZM23btk0PPvig30f3uXPn6r//+78VHx9/Tn/o0PsOZuPGjRVW58iRI5WUlKQpU6Zo+vTpAV9J5Ofn69VXXw3p55CKmz17thYsWOD7d0FBge644w7l5+erX79+fif1/fffr8LCQl177bVat25dQF1btmwpdYJsKOLj4zVs2DAVFBTo9ttv97sP8sEHH2j27NlBt/PeyH/hhRf0448/+spXrlypBx54oFx9qMi6zoWRI0dKku68804dPnzYV7569eqAiaGl2blzp2bMmBFwbp48edJ30z/YPaSlS5f6vc5mpkmTJmnnzp3KzMwM+iBEccnJyapSpYrWrVunpUuX+soLCws1YcKEEieSenkfPHj66aclnd2DBqWdo5UqVdKNN96ooqIijRkzxu/6uGnTJj3yyCOSpFtvvbVcbRYVFem2227zG+8VK1bo+eefV1hYmO91Lc2IESMUGxurN954Q++9955f3ffee6/27NmjNm3a6LLLLgtpX726d++uRo0aafny5eXap3I9au21ZMkS30SruLg46969uw0dOtR69+7tK4+JibGPPvrIt0155/ns3r3bN/kpMTHR+vfvbwMHDrTmzZuHNMnU7PTcnIiICLvwwgttxYoVIe3b2rVrLTEx0STZxRdfbDk5Ob75TaVNMj3z8d2y+laS48eP++YCdO7c2YYPH24jRozwPRpb1uOnJY3nkiVLrGrVqr5HaXv37m1ZWVnWunVrq1SpkkkKmCtQkjMnmXbu3NlycnLsoosuMklWs2bNoI86T5gwwSRZeHi4tW7d2rKzs61nz56+R/gzMzODthPskdaSxn3fvn1Wv359k05PQhwyZIh17drVwsLCbPTo0UG3KSoq8rWVnJxs11xzjXXs2NEiIyPtrrvuKtej1mdTV1mPswbbxqusR7vPdOLECbv00ktNOj3JNDs726666iqLioryjU8o+7pq1Srf+d+pUycbOnSo9e/f35KSknzziIrPG/P2c/To0ebxeKxt27aWk5NjTZo0Men0RNWVK1eW2a6Z2Z///GffcdSjRw8bPHiwpaenW2xsrI0ZM6bMR4Pbtm1rkqxGjRohzwEszvuYf+XKlW3gwIE2YsQIGzFihG958UmmycnJlp2dbVdffbVv0vltt90WclveMejTp4+lpaVZ9erVbdCgQb6JwSphKkIok0w7duxoOTk51rBhQ5MCJ5malX09Kt5WqMeg11mFj9npORVPPvmkde7c2ZKSkiwiIsIuuOACu/TSS23SpEkBM9zLGz5mpydHTp482Zo2bWqxsbGWkJBgjRs3tjvuuMPv4lbaBX7WrFkWHh5uVatWDfniumPHDvvDH/5gtWvXtsjISKtWrZoNGDDAvvzyy4B1Kzp8zE5PTu3Ro4dVqVLFPB6P3/ZnGz5mZnv27LE777zTGjVqZLGxsRYfH28ZGRk2ePBgmzVrVrknmW7bts1mzJhhzZs3t5iYGEtMTLTrr78+6K8beH388cd2zTXX+Ca9JicnW8uWLW38+PEBbxDOJnzMTs9Buemmmyw5OdliYmLskksusWnTppW6zcGDB23UqFGWkpJi0dHR1qRJE3vhhRfMrHzzfM6mLpfhY3b63L3rrrssNTXVoqKiLCMjwx5//HErLCwMeV8PHz5sTz75pF199dWWnp5uMTExVq1aNWvTpo09++yzAb88Ubyf8+bNs3bt2llcXJxVqVLF+vfvb//85z8D+lnaGL/yyivWokULi4uL8705XbNmTUjzUrzzme69996Qx+xMU6dOtcaNG/t+teDMC/3Ro0ftoYce8q2TkJBgHTt2tL/97W/laqf4GOzZs8euu+46S0pKsujoaMvMzCzxulJS+JiZLV261Pr27WuJiYkWGRlpaWlpNnr0aL95ecWVdj0q3lZ5w8dj5mjyDn4zunTpokWLFmnbtm0h/+YZft/y8vL0yiuvaOHChRXy/ymdLTNTo0aNtHnzZn377be+eVS/Vp9++qm6du2q3Nzc39z/V8b/ZArgd+Ptt9/Wpk2bdPXVV//qg+e37tw8Kw0AvyI33XSTDh48qL///e8KDw8/q0noqFiED4DfvGnTpikiIkIZGRl6+OGH1bJly/Pdpd897vkAAJzjng8AwDnCBwDgHOEDAHCO8AEAOEf4AACcI3wAAM4RPgAA5wgfAIBzhA8AwDnCBwDgHOEDAHCO8AEAOEf4AACcI3wAAM4RPgAA5wgfAIBzhA8AwDnCBwDgHOEDAHCO8AEAOEf4AACcI3wAAM4RPgAA5wgfAIBzhA8AwLlyh4/H4/H7i4yMVLVq1dSsWTPl5eVpzpw5KigoOBd9Ddn27dvl8XiUl5d3Xvvxe/Dpp59W+Fjn5eXJ4/Ho008/rbA6Afy6nPUnn9zcXOXm5ionJ0cdOnRQQUGBXn31VQ0cOFAXX3yxli9fXpH9rBCTJ0+Wx+PRjBkzzndXfvMYawCliTjbDYNdVLZs2aJ7771Xs2fPVteuXbV06VI1b978F3QPv3Zt27bV+vXrVaVKlfPdFQD/Rir0nk+9evU0a9YsjRgxQseOHdONN95YkdXjVyguLk6NGjVSjRo1zndXAPwbOScPHDz11FOqVKmSVq1apSVLlgQs/+KLL9S/f38lJSUpOjpa6enpuuWWW/Tdd98FrDtjxgx5PB5NnjxZO3fu1NChQ5WUlKTY2Fi1bt1a8+bNC6lP6enpeuihhyRJw4cP97tvFcq9hfz8fP3lL39R8+bNdcEFFyg+Pl716tVTdna2FixYENCWx+ORmemZZ55R48aNFRMTo9TUVN122206ePBgQP179+7V448/rs6dOys1NVVRUVGqXr26srKy9NVXX5W4Tx6PR5L0/PPPq2nTpoqNjdVFF12kxx9/XGYmSVq5cqX69OmjqlWrKiEhQQMGDNCOHTtCGreyBLvn80vHuiSrV6/WhAkT1KpVK9+xU7du3RKPHa/Zs2erTZs2io2NVUpKioYPH64ffvihxHtLu3bt0pgxY9SwYUPFxcWpatWqatKkiUaOHKmNGzeedf8BFGPlJMlC2WzgwIEmyf70pz/5lc+cOdPCw8PN4/FYhw4dbMiQIZaRkWGSLCUlxdavX++3/vTp002S5ebmWnJysqWlpdmAAQOsXbt2JsnCwsJswYIFftts27bNt43XnXfeaZmZmSbJOnToYLm5ub6/M9s8U0FBgbVv394kWa1atax///6WnZ1t7dq1s5iYGL92zMzq1KljkmzMmDEWGRlpPXr0sEGDBllKSopJsksuucQOHz7st80LL7xgkqx+/frWs2dPy87OthYtWpgki4yMDNjH4u2MHTvWYmJirEuXLtanTx9LSEgwSfbggw/akiVLLC4uzho3bmzXXnut1a9f3yRZvXr17NixY6XudygWLlxYoWNtZpabm2uSbOHChX7lgwcPtvDwcMvMzLT+/fvbgAEDLD093SRZjRo1bM+ePQF1TZ061SRZeHi4de/e3QYPHmypqamWnp5u/fr1C2hn165dVq1aNd/rNGjQIOvXr59lZmaax+Ox6dOnn+VIASjunIXPI488YpIsJyfHV7Zz506LjY21iIgImzdvnq+8sLDQxo4da5KsTZs2fvV4w0eS3Xrrrfbzzz/7lj399NMmyS6//PKQ+j5p0iSTVO4LiPcC279/fyssLPRbdvDgQfv666/9yryhULlyZb9lR44csW7dupkku+OOO/y2Wbt2ra1Zsyag7fnz51tUVJTVq1fPioqKgraTmppq69at85WvX7/eoqOjLS4uztLT023q1Km+ZSdPnvT14eWXXy7XOAQTLHzMzn6szUoOn48//ti+++47v7LCwkJ76KGHTJINHz7cb9mWLVssKirKYmJi7LPPPvOVHz9+3Hr37u07roq34+33U089FdCv7du327ffflvu/QEQ6JzN86lWrZok6aeffvKV/dd//ZeOHz+unJwc9enTx1ceFhamxx57TDVr1tRXX32lZcuWBdRXt25dPfXUU4qI+L9nJMaMGaMLL7xQy5Yt06lTp87Vruhf//qXJKlLly4KC/MfsipVqqhVq1ZBt/vjH//otyw+Pl7PPfecPB6Ppk2bppMnT/qWNWvWTJdccklAHT179lR2dra2bNmidevWBW3n4YcfVpMmTXz/btSokXr37q1jx44pLS1NY8eO9S2LiorS7bffLklatGhRGXv+69KtW7eAe0thYWF68MEHlZqaqv/5n//xW/byyy/r1KlTys3N1eWXX+4rj4mJ0TPPPBPwWkr/91p369YtYFmdOnVUr169itgV4HfvrJ92K4v9//sN3nsSkrR48WJJ0rBhwwLWj46OVnZ2tp555hktXrxYl112md/yLl26KDIy0q8sIiJCdevW1YoVK/Tjjz+es5vezZs3V1hYmJ544glVr15dvXv3VkJCQpnbDRkyJKDs4osvVmZmplavXq21a9eqTZs2vmUnT57U/PnztXz5cu3bt88XqN98840kafPmzWrWrFlAnT169Agoq1u3bonLvBfQvXv3lrkPvzY//vij3n33Xa1bt04HDx5UYWGhJOnnn3/WgQMHdODAAVWtWlWS9Pnnn0uSsrOzA+qpV6+eWrRooRUrVviVe98sjBkzRo888oguv/xyvzc8ACrGOTur9u/fL0m+C4Ek303h9PT0oNt4y4PdPK5Vq1bQbeLj4yXJ71NERcvIyNATTzyhu+++Wzk5OQoPD1fTpk11xRVXaPjw4X6fOoqrU6dO0PL09HStXr3abz+/+eYb9evXT9u3by+xH0eOHAlanpqaGlBWqVKlMpedyzE7F9544w3dfPPNOnr0aInrHDlyxHfMece3du3aQddNS0sLCJ+8vDx98MEHmj17trp166a4uDi1bt1avXr10o033qjk5OQK2hvg9+2cfe22evVqSVLjxo0DlhX/NBRMsOVlbXOu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",
      "text/plain": [
       "<Figure size 500x500 with 1 Axes>"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "# ==========================================================================================\n",
    "# ======================================= MAIN LOGIC =======================================\n",
    "# ==========================================================================================\n",
    "qp = np.deg2rad(param.init_qp)\n",
    "qp_d = param.init_qp_d\n",
    "\n",
    "qr = param.init_qr  # Initial reaction wheel angle\n",
    "qr_d = param.init_qr_d  # Initial reaction wheel speed\n",
    "\n",
    "curr_prev = 0\n",
    "curr_d = 0\n",
    "\n",
    "Tm = param.init_Tm  # Initial reaction wheel torque\n",
    "Tp = param.init_Tp  # Initial disturbance torque\n",
    "\n",
    "controller_stat_flag = False\n",
    "controller_stat_flag_last = False\n",
    "controller_time = 0\n",
    "controller_energy = 0\n",
    "\n",
    "timedt = 0\n",
    "dt = 1 / 100  # frequency (Hz)\n",
    "reqE = (m1 + m2) * g * L2 * math.cos(0)\n",
    "\n",
    "setpoint = 0 # do not adjust\n",
    "\n",
    "# For LQR control\n",
    "K, S, E = control.lqr(A_matrix, B_Matrix, Q_LQR, R_LQR, N_LQR)\n",
    "\n",
    "# For PID control\n",
    "s = control.TransferFunction.s\n",
    "G = (s/(-J-m1*L1*L1))/((s**3 + ((B/I1) + (B + dp)/(m2*L2*L2))*s**2 - ((m1*L1 + m2*L2)*g/((J + m2*L2*L2)*I1) - (B + dp)/((J+m2*L2*L2)*I1))*s - (m1*L1 + m2*L2)*B*g/((J+m2*L2*L2)*I1)))\n",
    "C = 1/s\n",
    "\n",
    "# Plot the root locus\n",
    "if param.Stabilize_Controller == \"PID\" and param.plot_rootlocus:\n",
    "    print(\"PID Mode\")\n",
    "    print(\"Waiting for root locus ...\")\n",
    "    print(G)\n",
    "    control.rlocus(C*G)\n",
    "    print(\"Systemzero: \", control.zero(G))\n",
    "    print(\"Systempoles: \", control.pole(G))\n",
    "    plt.title('Root Locus Plot')\n",
    "    plt.xlabel('Re')\n",
    "    plt.ylabel('Im')\n",
    "    plt.grid(True)\n",
    "    plt.show()\n",
    "    print(\"Initialize simulation\")\n",
    "\n",
    "\n",
    "d_flag = 0\n",
    "\n",
    "settled_flag = False\n",
    "wait_flag = False\n",
    "\n",
    "running = True\n",
    "input_flag = False\n",
    "input_string = \"\"\n",
    "\n",
    "pygame.init()\n",
    "\n",
    "width, height = 400, 560\n",
    "screen = pygame.display.set_mode((width, height))\n",
    "pygame.display.set_caption(\"Reaction Wheel Inverted Pendulum\")\n",
    "pygame_windows = gw.getWindowsWithTitle(\"Reaction Wheel Inverted Pendulum\")\n",
    "\n",
    "WHITE = (255, 255, 255)\n",
    "GREY = (100, 100, 100)\n",
    "RED = (255, 0, 0)\n",
    "BLACK = (0, 0, 0)\n",
    "\n",
    "font = pygame.font.Font(None, 36)\n",
    "clock = pygame.time.Clock()\n",
    "\n",
    "\n",
    "app = QApplication(sys.argv)\n",
    "win = QMainWindow()\n",
    "win.setWindowFlag(Qt.FramelessWindowHint)  # Remove the title bar\n",
    "fig = plt.figure(num=\"plot output\", figsize=(5, 5))\n",
    "plt.text(0, 0.4, \"Click on the pendulum display to plot.\\n\\nDon't spam, it lags.\", fontsize = 15)\n",
    "plt.axis('off')\n",
    "canvas = FigureCanvas(fig)\n",
    "win.setCentralWidget(canvas)\n",
    "win.show()\n",
    "plt.gcf().canvas.mpl_connect('button_press_event', on_click)\n",
    "timedt_data = []\n",
    "qp_data = []\n",
    "setpoint_data = []\n",
    "Tm_data = []\n",
    "qr_d_data = []\n",
    "\n",
    "while running:\n",
    "    for event in pygame.event.get():\n",
    "        if event.type == QUIT:\n",
    "            running = False\n",
    "        elif event.type == MOUSEBUTTONDOWN:\n",
    "            if 10 < event.pos[0] < 110 and 10 < event.pos[1] < 60:\n",
    "                input_flag = True\n",
    "            if 292 < event.pos[0] < 392 and 10 < event.pos[1] < 60:\n",
    "                qp = np.deg2rad(param.init_qp)\n",
    "                qp_d = param.init_qp_d \n",
    "                qr = param.init_qr\n",
    "                qr_d = param.init_qr_d\n",
    "                Tm = 0\n",
    "                Tp = 0\n",
    "                settled_flag = False\n",
    "                wait_flag = False\n",
    "                timedt = 0 \n",
    "                timedt_data = []\n",
    "                qp_data = []\n",
    "                setpoint_data = []\n",
    "                Tm_data = []\n",
    "                qr_d_data = []\n",
    "                controller_time = 0\n",
    "                controller_energy = 0\n",
    "            if event.pos[1] > 160:\n",
    "                plot_graph()\n",
    "        elif event.type == KEYDOWN:\n",
    "            if event.key == pygame.K_BACKSPACE:\n",
    "                input_string = input_string[:-1]\n",
    "            elif event.key == pygame.K_RETURN:\n",
    "                input_flag = True\n",
    "            else:\n",
    "                input_string += event.unicode\n",
    "\n",
    "    if input_flag == True:\n",
    "        try:\n",
    "            Tp = -float(input_string)\n",
    "        except:\n",
    "            Tp = 0\n",
    "            input_string = \"\"\n",
    "        input_flag = False\n",
    "    else:\n",
    "        Tp = 0\n",
    "\n",
    "    # ==========================================================================================\n",
    "    # ======================================= Controller =======================================\n",
    "    # ==========================================================================================\n",
    "    setpoint_offset = (qp - math.pi) / (2 * math.pi)\n",
    "    if setpoint_offset < 0:\n",
    "        setpoint = (math.floor(setpoint_offset) + 1) * 2 * math.pi\n",
    "    elif setpoint_offset > 0:\n",
    "        setpoint = math.ceil(setpoint_offset) * 2 * math.pi\n",
    "\n",
    "    E = PendulumEnergy(q=qp)\n",
    "\n",
    "    if wait_flag:\n",
    "        controller_mode = \"brake\"\n",
    "        if abs(E) < 0.05:\n",
    "            wait_flag = False\n",
    "    elif abs(qp) % (2 * math.pi) <= np.deg2rad(StabilizeBound) or abs(qp) % (2 * math.pi) >= np.deg2rad(360 - StabilizeBound):\n",
    "        settled_flag = True\n",
    "        controller_mode = param.Stabilize_Controller\n",
    "        controller_stat_flag = True\n",
    "    else:\n",
    "        if settled_flag:\n",
    "            wait_flag = True\n",
    "            settled_flag = False\n",
    "        if not wait_flag:\n",
    "            controller_mode = \"Bang-bang\"\n",
    "\n",
    "    if controller_mode == \"LQR\":\n",
    "        e = setpoint - qp\n",
    "        Vin = e * K[0, 0] + qp_d * -K[0, 1]\n",
    "    elif controller_mode == \"PID\":\n",
    "        e = setpoint - qp\n",
    "        Vin = -e * param.Kp\n",
    "    elif controller_mode == \"Bang-bang\":\n",
    "        if (qp_d < 0 and E < reqE) or (qp_d >= 0 and E >= reqE):\n",
    "            Vin = 12\n",
    "        elif (qp_d >= 0 and E < reqE) or (qp_d < 0 and E >= reqE):\n",
    "            Vin = -12\n",
    "        else:\n",
    "            Vin = 0\n",
    "    elif controller_mode == \"brake\":\n",
    "        if qp_d < 0:\n",
    "            Vin = -12\n",
    "        elif qp_d >= 0:\n",
    "            Vin = 12\n",
    "    else:\n",
    "        Vin = 0\n",
    "    if param.MotorLimit:\n",
    "        # Actual Limit\n",
    "        if Vin > 24:\n",
    "            Vin = 24\n",
    "        elif Vin < -24:\n",
    "            Vin = -24\n",
    "            \n",
    "    Tm = MotorDynamics(Vin, dt)\n",
    "    FREQUENCY = pow(abs(qr_d), 2)\n",
    "    qp_dd = RwipDynamics(qp, Tm, Tp)\n",
    "    qp_d = qp_d + (qp_dd * dt)\n",
    "    qp = qp + (qp_d * dt)\n",
    "\n",
    "    # Draw background\n",
    "    screen.fill(WHITE)\n",
    "    pygame.draw.rect(screen, (24, 24, 24), (0, 0, 401, 160))\n",
    "\n",
    "    # Draw grid\n",
    "    for i in range(0, 401, 50):\n",
    "        pygame.draw.line(screen, GREY, (i, 160), (i, 600), 1)\n",
    "    for i in range(160, 560, 50):\n",
    "        pygame.draw.line(screen, GREY, (0, i), (400, i), 1)\n",
    "\n",
    "    # Draw figure\n",
    "    plot_figure(screen, qp, qp_d, qr_d, Tm, Vin, Tp, setpoint)\n",
    "    timedt_data.append(timedt)\n",
    "    qp_data.append(qp)\n",
    "    setpoint_data.append(setpoint)\n",
    "    Tm_data.append(Tm)\n",
    "    qr_d_data.append(qr_d)\n",
    "\n",
    "    # move graph with pygame\n",
    "    win.move(pygame_windows[0].left + 420, pygame_windows[0].top + 50)\n",
    "    win.showNormal()\n",
    "\n",
    "    # Draw button\n",
    "    pygame.draw.rect(screen, GREY, (10, 10, 100, 50))\n",
    "    text = font.render(\"INJECT\", True, WHITE)\n",
    "    screen.blit(text, (20, 23))\n",
    "    pygame.draw.rect(screen, RED, (292, 10, 100, 50))\n",
    "    text = font.render(\"RESET\", True, (255, 255, 255))\n",
    "    screen.blit(text, (303, 23))\n",
    "\n",
    "    # Draw disturbance input field\n",
    "    pygame.draw.rect(screen, GREY, (110, 10, 130, 50))\n",
    "    pygame.draw.rect(screen, WHITE, (125, 20, 100, 30))\n",
    "    text = font.render(input_string, True, (0, 0, 0))\n",
    "    screen.blit(text, (130, 25))\n",
    "\n",
    "    # calculate FPS and draw\n",
    "    fps = clock.get_fps()\n",
    "    timedt += dt\n",
    "    if(abs(np.rad2deg(qp) - np.rad2deg(setpoint)) < 0.1):\n",
    "        controller_stat_flag = False\n",
    "    elif(controller_stat_flag):\n",
    "        controller_time += dt\n",
    "        controller_energy += abs(qr_d * Tm) * dt\n",
    "    if(controller_mode != param.Stabilize_Controller or not controller_stat_flag_last and controller_stat_flag and (abs(np.rad2deg(qp) - np.rad2deg(setpoint)) < 0.1)):\n",
    "        controller_time = 0\n",
    "        controller_energy = 0\n",
    "    controller_stat_flag_last = controller_stat_flag\n",
    "    if fps:\n",
    "        dt = 1 / fps\n",
    "\n",
    "    pygame.display.flip()\n",
    "    clock.tick(165)\n",
    "\n",
    "pygame.quit()\n",
    "stop_thread = True\n",
    "sys.exit()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "0bf9c352-9bd9-4839-969a-d5a4994b3de0",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.12.4"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
