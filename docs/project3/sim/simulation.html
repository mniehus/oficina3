

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Modelling and Simulation &mdash; oficina3  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
      <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../_static/design-tabs.js?v=f930bc37"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
      <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
      <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            oficina3
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">oficina3</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">LEFA Oficina 3 – Laboratório de Estimação e Controlo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html#lefa-oficina-3-estimation-and-control-lab">LEFA Oficina 3 – Estimation and Control Lab</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Projeto 1</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../project1/aeropendulum.html">Projeto 1: Desenvolvimento e Teste de um Aeropêndulo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project1/analogies.html">Analogias</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project1/pendulum-theory.html">Aeropendulum (theory)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project1/motorDC-theory.html">Motor DC (theory)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project1/motorDC-lab.html">Motor DC (drive)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project1/encoder.html">Encoder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project1/coding.html">Programar</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project1/motorCalib-PT.html">[PT] Máquinas de Estados aplicadas à Calibração de Motor DC</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project1/motorCalib-EN.html">[EN] State-Machines applied to DC Motor Calibration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project1/controlo-intro.html">Controlador</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project1/controller.html">PID Controller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project1/controlo-PID-arduino.html">Controlador PID</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project1/controlo-PID-arduino.html#Afinar-os-coeficientes-PID-('PID-tuning')">Afinar os coeficientes PID (‘PID tuning’)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project1/controlo-PID-arduino.html#Procedimento-/-Metodologia-para-ajuste-manual">Procedimento / Metodologia para ajuste manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project1/controlo-PID-arduino.html#PID-no-arduino-(exemplo-1)">PID no arduino (exemplo 1)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project1/controlo-PID-arduino.html#PID-no-arduino-(exemplo-2)">PID no arduino (exemplo 2)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project1/controlo-ref-code-aeropendulo.html">Código exemplo para aeropendulum simulado</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../project1/integration.html">Integração do Sistema</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Projeto 2</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../project2/readme.html">Carro programável</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Project 3</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../readme.html">Inverted Pendulum</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">oficina3</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Modelling and Simulation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/project3/sim/simulation.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Modelling-and-Simulation">
<h1>Modelling and Simulation<a class="headerlink" href="#Modelling-and-Simulation" title="Link to this heading"></a></h1>
<p>This page is based on a Jupyter notebook, which is accessible through the repository.</p>
<p>Additionally, it was exported to python source code, which can equally be downloaded and run.</p>
<p>It is recommended to use a virtual environment and the associated requirements file.</p>
<p>Running the jupyter/python simulation file, two graphic windows open (case they do not pop up pls check in the PC task bar and make them visible): on the left hand side, an interactive animation (with possibility to apply a perturbation torque, and to reset to initial conditions), and on the right hand side, the time series of control variables - they are updated on a click.</p>
<section id="Parameters">
<h2>Parameters<a class="headerlink" href="#Parameters" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Wheel parameters</p></li>
<li><p>DC Motor parameters</p></li>
<li><p>Pendulum parameters</p></li>
<li><p>Sensor parameters</p></li>
<li><p>Controller parameters</p></li>
<li><p>System parameters</p></li>
<li><p>Simulation configuration</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

<span class="c1"># Parameters</span>
<span class="c1"># to-do: if not self-explaining, add info how to calculate or measure</span>

<span class="n">g</span> <span class="o">=</span> <span class="mf">9.81</span>  <span class="c1"># Gravitational acceleration (m*s^2)</span>

<span class="c1"># Wheel parameters</span>
<span class="n">wheelradius</span> <span class="o">=</span> <span class="mf">0.3</span>  <span class="c1"># Radius of Reaction wheel (m)</span>
<span class="n">wheelheight</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1"># height of Reaction wheel (m)</span>
<span class="n">wheelrho</span><span class="o">=</span><span class="mi">1250</span> <span class="c1"># mass density of 100% infill PLA — as used in 3D printing — is typically 1.25 g/cm³</span>
<span class="c1">#m2 = 0.1  # Mass of Wheel (kg)</span>
<span class="n">m2</span> <span class="o">=</span> <span class="mf">3.14</span><span class="o">*</span><span class="n">wheelradius</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">wheelheight</span><span class="o">*</span><span class="n">wheelrho</span>  <span class="c1"># Mass of Wheel (kg)</span>
<span class="c1">#I2 = 0.0027  # Inertia moment of Wheel (Kg*m^2)</span>
<span class="n">I2</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">m2</span><span class="o">*</span><span class="n">wheelradius</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># Inertia moment of Wheel (Kg*m^2)</span>

<span class="c1"># DC  Motor parameters</span>
<span class="c1">#would be nice to have combinations for motor1, motor2, and motor3</span>
<span class="n">motormass</span><span class="o">=</span><span class="mf">0.1</span> <span class="c1">#kg, ad hoc estimate</span>
<span class="n">m2</span> <span class="o">=</span> <span class="n">m2</span><span class="o">+</span><span class="n">motormass</span>  <span class="c1"># updated</span>
<span class="n">I2</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">m2</span><span class="o">*</span><span class="n">wheelradius</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># Inertia moment of Wheel (Kg*m^2)</span>
<span class="c1">#max voltages</span>
<span class="c1">#max rpm</span>
<span class="n">ke</span> <span class="o">=</span> <span class="mf">3.69e-2</span>  <span class="c1"># Electrical constant of DC Motor (V/(rad/s))</span>
<span class="n">Ng</span> <span class="o">=</span> <span class="mf">0.83</span>  <span class="c1"># Transmission ratio of DC Motor</span>
<span class="n">kt</span> <span class="o">=</span> <span class="n">ke</span> <span class="o">*</span> <span class="n">Ng</span>  <span class="c1"># Mechanical constant of DC Motor (Nm/A)</span>
<span class="n">R</span> <span class="o">=</span> <span class="mf">2.85</span>  <span class="c1"># Resistor of DC Motor (Ohm)</span>
<span class="n">L</span> <span class="o">=</span> <span class="mf">3.73e-4</span>  <span class="c1"># Inductance of DC Motor (Henry)</span>
<span class="n">J</span> <span class="o">=</span> <span class="mf">0.0027</span>  <span class="c1"># Inertia Motor (Kgm^2)</span>
<span class="c1">#B = 3.85e-3  # Damping of DC Motor (Nm/(rad/s))</span>
<span class="c1">#B = 3.85e-5  # Damping of DC Motor (Nm/(rad/s))</span>
<span class="n">B</span> <span class="o">=</span> <span class="mf">3.85e-7</span>  <span class="c1"># Damping of DC Motor (Nm/(rad/s))</span>

<span class="c1">#time constants</span>
<span class="n">tau_el</span><span class="o">=</span><span class="n">L</span><span class="o">/</span><span class="n">R</span>  <span class="c1">#electrical constant (order 0.1 ms)</span>
<span class="n">tau_mech</span><span class="o">=</span><span class="n">J</span><span class="o">/</span><span class="n">B</span>  <span class="c1">#mechanical constant (order 100 ms)</span>
<span class="c1"># Motor Limit</span>
<span class="n">MotorLimit</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Set to False if you don&#39;t serious about hardware Limitation</span>
<span class="c1"># internal encoder ?</span>
<span class="c1"># gear properties ?</span>
<span class="c1"># gear ratio</span>
<span class="c1"># driver properties ? PWM vs DAC ?</span>
<span class="c1"># power supply ?</span>

<span class="c1"># Pendulum parameters</span>
<span class="n">L1</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># Length of Pendulum (from pivot to center of mass) (m)</span>
<span class="c1">#L2 = 0.18  # Length of Pendulum (m)</span>
<span class="n">L2</span> <span class="o">=</span> <span class="n">L1</span>  <span class="c1"># Length of Pendulum (m)</span>
<span class="c1">#m1 = 0.1  # Mass of Pendulum (kg)</span>
<span class="n">m1</span> <span class="o">=</span> <span class="n">m2</span>  <span class="c1"># Mass of Pendulum (kg)</span>
<span class="c1">#I1 = 0.0212  # Inertia moment of Pendulum (Kg*m^2)</span>
<span class="n">I1</span> <span class="o">=</span> <span class="n">m2</span><span class="o">*</span><span class="n">L1</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># Inertia moment of Pendulum (Kg*m^2)</span>
<span class="n">dp</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1"># Pendulum damping constant (unit ? how to calculate, how to measure)</span>

<span class="c1"># Sensor parameters</span>


<span class="c1">#Controller parameters</span>
<span class="n">Stabilize_Controller</span> <span class="o">=</span> <span class="s2">&quot;LQR&quot;</span> <span class="c1"># Select stabilize mode: &quot;LQR&quot; or &quot;PID&quot;</span>
<span class="n">StabilizeBound</span> <span class="o">=</span> <span class="mi">25</span>  <span class="c1"># Angle at which switch from Bang-bang swing up to PID/LQR starts to stabilize (degree)</span>
<span class="c1"># criteria for break mode ?</span>

<span class="c1"># Manual controller parameters?</span>
<span class="c1"># some manual control wheel with some handle or so ?</span>
<span class="c1"># some kinda gaming wheel as user interface ? with some haptic/manual feedback ?</span>

<span class="c1"># Controller parameters for Bang-bang?</span>
<span class="c1"># Margin ?</span>

<span class="c1"># Controller parameters for PID</span>
<span class="n">Kp</span> <span class="o">=</span> <span class="mi">2143</span> <span class="c1">#PID gain others ? how to calculate</span>

<span class="c1"># Controller parameters for LQR</span>
<span class="n">Q_LQR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">342</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># Weight for qp</span>
                  <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">541</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># Weight for qp_d</span>
                  <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># Weight for qr</span>
                  <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>  <span class="c1"># Weight for qr_d</span>
<span class="n">R_LQR</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># Weight for the control input</span>

<span class="n">N_LQR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># No cross-coupling terms for LQR</span>
                  <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                  <span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

<span class="c1">#System parameters ?</span>
<span class="c1"># Arduino ? Delay? Digitation? Memory? Speed?</span>

<span class="c1"># Simulation configuration</span>
<span class="c1">#time</span>
<span class="c1"># Sound</span>
<span class="n">Sound</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Flag to enable/disable sound</span>
<span class="n">plot_rootlocus</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># Flag to enable/disable Plot root locus</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">resetInitialState</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">init_qp</span><span class="p">,</span><span class="n">init_qp_d</span> <span class="p">,</span><span class="n">init_qr</span><span class="p">,</span><span class="n">init_qr_d</span><span class="p">,</span><span class="n">init_Tm</span><span class="p">,</span><span class="n">init_Tp</span>

    <span class="c1"># Initial state</span>

    <span class="n">init_qp</span> <span class="o">=</span> <span class="mf">180.0</span>  <span class="c1"># Initial pendulum angle (degree)</span>
    <span class="n">init_qp_d</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Initial pendulum speed</span>

    <span class="n">init_qr</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Initial reaction wheel angle</span>
    <span class="n">init_qr_d</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Initial reaction wheel speed</span>

    <span class="n">init_Tm</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Initial reaction wheel torque</span>
    <span class="n">init_Tp</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Initial disturbance torque</span>

<span class="n">resetInitialState</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
</section>
<section id="Wheel-simulation">
<h2>Wheel simulation<a class="headerlink" href="#Wheel-simulation" title="Link to this heading"></a></h2>
</section>
<section id="DC-motor-simulation">
<h2>DC motor simulation<a class="headerlink" href="#DC-motor-simulation" title="Link to this heading"></a></h2>
<p>Model</p>
<p><img alt="DC motor diagrams" src="project3/img/dcmotor.png" /></p>
<p>Parameter</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">va</span></code> - Applied Voltage</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">R</span></code> - Resistance</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">L</span></code> - Inductance</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">i</span></code> - Current</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">b</span></code> - Damping coefficient</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">J</span></code> - Rotor Inertia</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ke</span></code> - Back EMF constant</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kt</span></code> - Torque constant</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">θ</span></code> - Rotor shaft angle</p></li>
</ul>
<p><strong>Dynamical model</strong></p>
<p>Electrical part</p>
<p>  <span class="math notranslate nohighlight">\(va = R i + L \frac{di}{dt} + k_e \frac{dθ}{dt}\)</span></p>
<p>Electromechanical Conversion</p>
<p>  <span class="math notranslate nohighlight">\(T_{m} = k_t i\)</span></p>
<p>Mechanical Part (inertia plus load)</p>
<p>  <span class="math notranslate nohighlight">\(T_{m} = b \frac{dθ}{dt} + J\frac{d^2θ}{dt^2}\)</span></p>
<p>If required, mechanical part can also include Coulomb (static) or Reynolds (aerodynamic) friction</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">MotorDynamics</span><span class="p">(</span><span class="n">va</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    updates dc motor torque based on input voltage and time step</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">global</span> <span class="n">qr_d</span><span class="p">,</span> <span class="n">qr</span><span class="p">,</span> <span class="n">curr_prev</span><span class="p">,</span> <span class="n">curr_d</span><span class="p">,</span> <span class="n">curr</span>

    <span class="n">curr</span> <span class="o">=</span> <span class="p">(</span><span class="n">va</span> <span class="o">-</span> <span class="n">qr_d</span> <span class="o">*</span> <span class="n">ke</span> <span class="o">-</span> <span class="n">L</span> <span class="o">*</span> <span class="n">curr_d</span><span class="p">)</span> <span class="o">/</span> <span class="n">R</span>
    <span class="n">curr_d</span> <span class="o">=</span> <span class="p">(</span><span class="n">curr</span> <span class="o">-</span> <span class="n">curr_prev</span><span class="p">)</span><span class="o">/</span><span class="n">dt</span>
    <span class="n">Tm</span> <span class="o">=</span> <span class="n">curr</span> <span class="o">*</span> <span class="n">kt</span>
    <span class="n">qr_dd</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tm</span> <span class="o">-</span> <span class="n">B</span> <span class="o">*</span> <span class="n">qr_d</span><span class="p">)</span> <span class="o">/</span> <span class="n">J</span>
    <span class="n">qr_d</span> <span class="o">=</span> <span class="n">qr_d</span> <span class="o">+</span> <span class="n">qr_dd</span> <span class="o">*</span> <span class="n">dt</span>
    <span class="n">qr</span> <span class="o">=</span> <span class="n">qr</span> <span class="o">+</span> <span class="n">qr_d</span> <span class="o">*</span> <span class="n">dt</span>
    <span class="n">curr_prev</span> <span class="o">=</span> <span class="n">curr</span>
    <span class="k">return</span> <span class="n">Tm</span>
<br/></pre></div>
</div>
</div>
<section id="DC-motor--Steady-state-analysis">
<h3>DC motor -Steady-state analysis<a class="headerlink" href="#DC-motor--Steady-state-analysis" title="Link to this heading"></a></h3>
<p><strong>Steady state model</strong></p>
<p>By zeroing the time variations (dynamic derivatives):</p>
<p>  $ L :nbsphinx-math:<a href="#id1"><span class="problematic" id="id2">`</span></a>frac{di}{dt}`=0$</p>
<p>  <span class="math notranslate nohighlight">\(J\frac{dω}{dt}=0\)</span></p>
<p>The electrical part becomes</p>
<p>  $va = R i + k_e ω $</p>
<p>The mechanical part becomes</p>
<p>  <span class="math notranslate nohighlight">\(T_{m} = k_t i\)</span></p>
<p>A typical (minimal) load:</p>
<p>  <span class="math notranslate nohighlight">\(T_{m} = b ω\)</span></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">MotorSteadyState</span><span class="p">(</span><span class="n">va</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    updates dc motor torque based on input voltage and time step</span>


<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#global qr_d, qr, curr_prev, curr_d, curr</span>
    <span class="n">curr</span> <span class="o">=</span> <span class="p">(</span><span class="n">va</span> <span class="o">-</span> <span class="n">qr_d</span> <span class="o">*</span> <span class="n">ke</span><span class="p">)</span> <span class="o">/</span> <span class="n">R</span>
    <span class="n">curr_d</span> <span class="o">=</span> <span class="p">(</span><span class="n">curr</span> <span class="o">-</span> <span class="n">curr_prev</span><span class="p">)</span><span class="o">/</span><span class="n">dt</span>
    <span class="n">Tm</span> <span class="o">=</span> <span class="n">curr</span> <span class="o">*</span> <span class="n">kt</span>
    <span class="n">qr_dd</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tm</span> <span class="o">-</span> <span class="n">B</span> <span class="o">*</span> <span class="n">qr_d</span><span class="p">)</span> <span class="o">/</span> <span class="n">J</span>
    <span class="n">qr_d</span> <span class="o">=</span> <span class="n">qr_d</span> <span class="o">+</span> <span class="n">qr_dd</span> <span class="o">*</span> <span class="n">dt</span>
    <span class="n">qr</span> <span class="o">=</span> <span class="n">qr</span> <span class="o">+</span> <span class="n">qr_d</span> <span class="o">*</span> <span class="n">dt</span>
    <span class="n">curr_prev</span> <span class="o">=</span> <span class="n">curr</span>
    <span class="k">return</span> <span class="n">Tm</span>
<br/></pre></div>
</div>
</div>
<p><strong>Speed-Torque Curve</strong></p>
<p>  <span class="math notranslate nohighlight">\(T_{m} =  \frac{k_t}{R} (va-k_e ω)\)</span></p>
<p>  <span class="math notranslate nohighlight">\(\Leftrightarrow\)</span> <span class="math notranslate nohighlight">\(ω = \frac{va}{k_e}-\frac{R}{k_e k_t}T_m\)</span></p>
<p>This linear inverse correlation is called the <strong>load line</strong>.</p>
<p><strong>Reference points</strong></p>
<p>  $ω(T_m=0) = <span class="math">\frac{va}{k_e}</span> = ω_{max} $ (zero load, zero torque, maximum speed)</p>
<p>  <span class="math notranslate nohighlight">\(T_m(ω=0) = \frac{k_t}{R} va = k_t I_{stall}= Tm_{max}\)</span> (full load, maximum torque, zero speed)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># Parameters</span>
<span class="n">va</span> <span class="o">=</span> <span class="mi">5</span>            <span class="c1">#applied voltage</span>

<span class="c1"># Torque range</span>
<span class="n">Tm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">kt</span><span class="o">*</span><span class="n">va</span><span class="o">/</span><span class="n">R</span> <span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="c1"># Speed-torque curve</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">va</span><span class="o">/</span><span class="n">ke</span> <span class="o">-</span> <span class="n">R</span> <span class="o">/</span> <span class="p">(</span><span class="n">ke</span> <span class="o">*</span> <span class="n">kt</span><span class="p">)</span> <span class="o">*</span> <span class="n">Tm</span>

<span class="c1"># Current curve</span>
<span class="n">Im</span><span class="o">=</span><span class="n">Tm</span><span class="o">/</span><span class="n">kt</span>

<span class="c1"># Power curve</span>
<span class="n">P</span> <span class="o">=</span> <span class="n">omega</span> <span class="o">*</span> <span class="n">Tm</span>

<span class="c1"># Set axis limits</span>
<span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">=</span> <span class="n">Tm</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">Tm</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="n">omega</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">*</span><span class="mi">60</span><span class="o">/</span><span class="mf">6.28</span><span class="p">,</span> <span class="n">omega</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">*</span><span class="mi">60</span><span class="o">/</span><span class="mf">6.28</span>
<span class="n">p_min</span><span class="p">,</span> <span class="n">p_max</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">P</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="n">I_min</span><span class="p">,</span> <span class="n">I_max</span> <span class="o">=</span> <span class="n">Im</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">Im</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Main plot: Torque vs Speed</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Tm</span><span class="p">,</span> <span class="n">omega</span><span class="o">*</span><span class="mi">60</span><span class="o">/</span><span class="mf">6.28</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Load line&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Tm</span><span class="p">,</span> <span class="n">Tm</span><span class="o">/</span><span class="n">B</span><span class="o">*</span><span class="mi">60</span><span class="o">/</span><span class="mf">6.28</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Actual load&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Speed $</span><span class="se">\\</span><span class="s1">omega$ (rpm)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Torque $T_m$ (Nm)&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="s1">&#39;outward&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span>

<span class="sd">&quot;&quot;&quot; # Additional x-axis for Current (aligned with Tm, sharing origin)</span>
<span class="sd">ax2 = ax1.twiny()</span>
<span class="sd">ax2.set_xlim(ax1.get_xlim())</span>
<span class="sd">tm_ticks = ax1.get_xticks()</span>
<span class="sd">ax2.set_xticks(tm_ticks)</span>
<span class="sd">ax2.set_xticklabels([f&quot;{(tick/kt):.1f}&quot; for tick in tm_ticks])</span>
<span class="sd">ax2.xaxis.set_label_position(&#39;bottom&#39;)</span>
<span class="sd">ax2.xaxis.set_ticks_position(&#39;bottom&#39;)</span>
<span class="sd">ax2.spines[&#39;bottom&#39;].set_position((&#39;outward&#39;, 40))</span>
<span class="sd">ax2.set_xlabel(&#39;Current $I$ (A)&#39;, loc=&#39;right&#39;) &quot;&quot;&quot;</span>

<span class="c1"># Additional y-axis for Current</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Tm</span><span class="p">,</span> <span class="n">Im</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Current&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="s1">&#39;outward&#39;</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ax1</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">())</span>
<span class="c1">#omega_ticks = ax1.get_yticks()</span>
<span class="c1">#ax3.set_yticks(omega_ticks)</span>
<span class="c1">#ax3.set_yticklabels([f&quot;{(ke*tick/(60/6.28) ):.1f}&quot; for tick in omega_ticks])</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Current $I$ (A)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>
<span class="n">ax3</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">I_min</span><span class="p">,</span> <span class="n">I_max</span><span class="p">)</span>  <span class="c1"># restrict power axis to min/max</span>

<span class="c1"># Additional y-axis for Power</span>
<span class="n">ax4</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Tm</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Power&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Power $P$ (W)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">p_min</span><span class="p">,</span> <span class="n">p_max</span><span class="p">)</span>  <span class="c1"># restrict power axis to min/max</span>

<span class="c1"># Grid on both x and y axes</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="c1">#ax4.legend()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/project3_sim_simulation_12_0.png" src="../../_images/project3_sim_simulation_12_0.png" />
</div>
</div>
</section>
</section>
<section id="Static-transfer-curve---voltage-vs-speed">
<h2>Static transfer curve - voltage vs speed<a class="headerlink" href="#Static-transfer-curve---voltage-vs-speed" title="Link to this heading"></a></h2>
<p>Electrical part</p>
<p>  <span class="math notranslate nohighlight">\(va = R i + k_e ω\)</span></p>
<p>Mechanical Part</p>
<p>  <span class="math notranslate nohighlight">\(T_{m} = k_t i = b ω\)</span></p>
<p>Transfer curve</p>
<p>  $va = R <span class="math">\frac{b ω}{k_t}</span> + k_e ω = (1+:nbsphinx-math:<cite>frac{Rb}{k_e k_t}</cite>) k_e ω $</p>
<p>  $ω = <span class="math">\frac{va}{(1+\frac{Rb}{k_e k_t}) k_e}</span> $</p>
<section id="Transient-analysis---time-series-data">
<h3>Transient analysis - time series data<a class="headerlink" href="#Transient-analysis---time-series-data" title="Link to this heading"></a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># Voltage range</span>
<span class="n">va</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="c1"># Speed-voltage static transfer curve</span>
<span class="n">omega</span> <span class="o">=</span>  <span class="n">va</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">R</span> <span class="o">*</span> <span class="n">B</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ke</span> <span class="o">*</span> <span class="n">kt</span><span class="p">))</span> <span class="o">*</span> <span class="n">ke</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">va</span><span class="p">,</span> <span class="n">omega</span><span class="o">*</span><span class="mi">60</span><span class="o">/</span><span class="mf">6.28</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Voltage $v_a$ (V)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Speed $</span><span class="se">\\</span><span class="s1">omega$ (rpm)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Speed-Voltage Static Transfer Curve&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/project3_sim_simulation_15_0.png" src="../../_images/project3_sim_simulation_15_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Time series Test function for DC motor simulator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="k">def</span><span class="w"> </span><span class="nf">simulationTest_motordc_timeSeries</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">TH</span><span class="p">,</span><span class="n">tag</span><span class="p">,</span><span class="n">mode</span><span class="p">):</span>
    <span class="c1"># initialize start values</span>
    <span class="n">qr</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">qr_d</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">curr</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">curr_prev</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">curr_d</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="c1">#initialize output</span>
    <span class="n">Tmm</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Imm</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">wmm</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Vmm</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t_end</span> <span class="o">+</span> <span class="n">dt</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">tx</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
        <span class="c1">#value = MotorDynamics(vx, dt)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">mode</span><span class="o">==</span><span class="s1">&#39;ramp&#39;</span><span class="p">):</span>
            <span class="n">vx</span><span class="o">=</span><span class="mi">5</span><span class="o">*</span><span class="n">tx</span><span class="o">/</span><span class="n">t_end</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">mode</span><span class="o">==</span><span class="s1">&#39;step&#39;</span><span class="p">):</span>
            <span class="n">vx</span><span class="o">=</span><span class="mi">5</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">mode</span><span class="o">==</span><span class="s1">&#39;pwm&#39;</span><span class="p">):</span>
            <span class="n">vx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">tx</span> <span class="o">%</span> <span class="n">T</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">TH</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1">#pwm</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">mode</span><span class="o">==</span><span class="s1">&#39;onoff&#39;</span><span class="p">):</span>
            <span class="n">vx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tx</span> <span class="o">&lt;</span> <span class="n">t_end</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1">#pwm</span>
        <span class="c1">#curr = (vx - qr_d * ke - L * curr_d) / R</span>
        <span class="c1">#curr_d = (curr - curr_prev)/dt</span>
        <span class="n">curr_d</span> <span class="o">=</span> <span class="p">(</span><span class="n">vx</span> <span class="o">-</span> <span class="n">qr_d</span> <span class="o">*</span> <span class="n">ke</span> <span class="o">-</span> <span class="n">R</span> <span class="o">*</span> <span class="n">curr</span><span class="p">)</span> <span class="o">/</span> <span class="n">L</span>
        <span class="n">curr</span> <span class="o">=</span> <span class="n">curr</span> <span class="o">+</span> <span class="n">curr_d</span> <span class="o">*</span> <span class="n">dt</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">curr</span> <span class="o">*</span> <span class="n">kt</span>
        <span class="n">qr_dd</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">B</span> <span class="o">*</span> <span class="n">qr_d</span><span class="p">)</span> <span class="o">/</span> <span class="n">J</span>
        <span class="n">qr_d</span> <span class="o">=</span> <span class="n">qr_d</span> <span class="o">+</span> <span class="n">qr_dd</span> <span class="o">*</span> <span class="n">dt</span>
        <span class="n">qr</span> <span class="o">=</span> <span class="n">qr</span> <span class="o">+</span> <span class="n">qr_d</span> <span class="o">*</span> <span class="n">dt</span>
        <span class="n">curr_prev</span> <span class="o">=</span> <span class="n">curr</span>
        <span class="n">Tmm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">wmm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qr_d</span><span class="p">)</span>
        <span class="n">Imm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span>
        <span class="n">Vmm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span>

    <span class="n">Tmm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Tmm</span><span class="p">)</span>
    <span class="n">wmm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">wmm</span><span class="p">)</span>
    <span class="n">Imm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Imm</span><span class="p">)</span>
    <span class="n">Vmm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Vmm</span><span class="p">)</span>

    <span class="c1"># Top-left: Time series input (voltage)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Vmm</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Applied (PWM)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Voltage (V)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Bottom-left: Time series output1 (angular velocity)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">wmm</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Output: Angular Velocity&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Angular Velocity (rad/s)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Top-right: Time series output2 (motor torque)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Tmm</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Output:Torque&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Motor Torque (Nm)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Bottom-right: Time series output3 (current)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Imm</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tag</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Output: Current&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Current (A)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
</section>
</section>
<section id="Simulation---time-series---voltage-step-function---short-time-scale-(ms)">
<h2>Simulation - time series - voltage step function - short time scale (ms)<a class="headerlink" href="#Simulation---time-series---voltage-step-function---short-time-scale-(ms)" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Time vector: step 0.1 ms, end time 3 ms</p></li>
<li><p>Applied voltage:</p>
<ul>
<li><p>step function from 0 to 5V</p></li>
</ul>
</li>
<li><p>Results:</p>
<ul>
<li><p>Current and Torque follow the applied signal, with a lag due to the motors electrical time constant <span class="math notranslate nohighlight">\(t_{el}=\frac{J}{B} \approx 0.1 ms\)</span></p></li>
<li><p>The amplitude of current and torque are determined by resistance and conversion coefficient</p></li>
<li><p>The angular velocity increases linearly over time, as expected for integration on this short time scale.</p></li>
<li><p>While the curves were calculated numerically, the result matches the well known analytical function for RL circuit.</p></li>
</ul>
</li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">T</span><span class="o">=</span><span class="mf">1e-3</span>
<span class="n">TH</span><span class="o">=</span><span class="n">T</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">])</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.01e-3</span>
<span class="n">t_end</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">simulationTest_motordc_timeSeries</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="s1">&#39;step&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/project3_sim_simulation_18_0.png" src="../../_images/project3_sim_simulation_18_0.png" />
</div>
</div>
</section>
<section id="Simulation---time-series---voltage-step-function---long-time-scale-(seconds)">
<h2>Simulation - time series - voltage step function - long time scale (seconds)<a class="headerlink" href="#Simulation---time-series---voltage-step-function---long-time-scale-(seconds)" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Time vector: step 0.1 ms, end time 3 s</p></li>
<li><p>Applied voltage:</p>
<ul>
<li><p>step function from 0 to 5V</p></li>
</ul>
</li>
<li><p>Results:</p>
<ul>
<li><p>Current and Torque follow the applied signals step function, with negligible delay on this time scale</p></li>
<li><p>The amplitude of current and torque are determined by resistance and conversion coefficient</p></li>
<li><p>The angular velocity increases linearly and then reaches its terminal value.</p></li>
<li><p>Current and torque decrease near to terminal velocity.</p></li>
<li><p>The motors mechanical time constant <span class="math notranslate nohighlight">\(t_{mech}=\frac{J}{B}\)</span> governs the time time scale towards reaching final value.</p></li>
<li><p>At low load (low rotational inertia) the mechanical time constant is of order ~0.1 s.</p></li>
<li><p>When additional load attached, the rotational inertia increases, and so does the time constant.</p></li>
</ul>
</li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">T</span><span class="o">=</span><span class="mf">1e-3</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1e-3</span>
<span class="n">t_end</span> <span class="o">=</span> <span class="mf">3000e-3</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">simulationTest_motordc_timeSeries</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="s1">&#39;step&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/project3_sim_simulation_20_0.png" src="../../_images/project3_sim_simulation_20_0.png" />
</div>
</div>
</section>
<section id="Simulation---time-series---voltage-On/Off---long-time-scale-(seconds)">
<h2>Simulation - time series - voltage On/Off - long time scale (seconds)<a class="headerlink" href="#Simulation---time-series---voltage-On/Off---long-time-scale-(seconds)" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Time vector: step 0.1 ms, end time 5 s</p></li>
<li><p>Applied voltage:</p>
<ul>
<li><p>5 V first half, then 0V</p></li>
</ul>
</li>
<li><p>Results:</p>
<ul>
<li><p>Current and Torque follow the Voltage, but with transient overshoots</p></li>
<li><p>When switching from On to Off, current and torque show a negative transient</p></li>
<li><p>The significant negative current peak can be a problem for DC power supply</p></li>
<li><p>To protect power supplies, it is best practice to connect a diode or a capacitor in parallel to the DC motor</p></li>
</ul>
</li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">T</span><span class="o">=</span><span class="mf">1e-3</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1e-3</span>
<span class="n">t_end</span> <span class="o">=</span> <span class="mf">5000e-3</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">simulationTest_motordc_timeSeries</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="s1">&#39;onoff&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/project3_sim_simulation_22_0.png" src="../../_images/project3_sim_simulation_22_0.png" />
</div>
</div>
</section>
<section id="Simulation---time-series---voltage-ramp">
<h2>Simulation - time series - voltage ramp<a class="headerlink" href="#Simulation---time-series---voltage-ramp" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Time vector: step 0.1 ms, end time 1 s</p></li>
<li><p>Applied voltage:</p>
<ul>
<li><p>Linear Voltage ramp from 0-5V</p></li>
</ul>
</li>
<li><p>Results:</p>
<ul>
<li><p>Current and Torque follow the applied signal</p></li>
<li><p>The angular velocity increases quadratically (integrative effect)</p></li>
<li><p>Using smooth transition with linear voltage ramps is always a good strategy.</p></li>
</ul>
</li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">T</span><span class="o">=</span><span class="mf">1e-3</span>
<span class="n">TH</span><span class="o">=</span><span class="n">T</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">])</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1e-3</span>
<span class="n">t_end</span> <span class="o">=</span> <span class="mf">1000e-3</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">simulationTest_motordc_timeSeries</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="s1">&#39;ramp&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/project3_sim_simulation_24_0.png" src="../../_images/project3_sim_simulation_24_0.png" />
</div>
</div>
</section>
<section id="Simulation---time-series---PWM---short-time-scale-(milliseconds)">
<h2>Simulation - time series - PWM - short time scale (milliseconds)<a class="headerlink" href="#Simulation---time-series---PWM---short-time-scale-(milliseconds)" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Time vector: step 0.1 ms, end time 10 ms</p></li>
<li><p>Applied voltage:</p>
<ul>
<li><p>0-5 V TTL PWM</p></li>
<li><p>PWM frqeuency f = 490 Hz or 980 Hz (typical values for Arduino PWM)</p></li>
<li><p>Duty cycle as parameter: 25%, 50%, 75%</p></li>
</ul>
</li>
<li><p>Results:</p>
<ul>
<li><p>Current and Torque follow the applied signal, with a lag due to the motors electrical time constant $:nbsphinx-math:<cite>t</cite>_{el}=:nbsphinx-math:<cite>frac{J}{B}</cite> <span class="math">\approx 0.1</span> ms</p></li>
<li><p>The amplitude of current and torque are determined by resistance and conversion coefficient</p></li>
<li><p>The response can be classified comparing the time constants:</p>
<ul>
<li><p>for the pwm signal, we have period <span class="math notranslate nohighlight">\(T=1/f_{pwm}\)</span>, high time <span class="math notranslate nohighlight">\(T_H=duty \cdot T\)</span> , and low time <span class="math notranslate nohighlight">\(T_L=(1-duty) \cdot T\)</span></p></li>
<li><p>for the motor, we have the motors electrical time constant <span class="math notranslate nohighlight">\(t_{el}=\frac{J}{B} \approx 0.1 ms\)</span></p></li>
</ul>
</li>
<li><p>The motors mechanical time constant <span class="math notranslate nohighlight">\(t_{mech}=\frac{J}{B} \approx 100 ms\)</span> is not relevant on this time scale</p></li>
<li><p>The angular velocity increases linearly over time, as expected for integration on this short time scale.</p></li>
<li><p>It shows a ripple when pwm time constants are near to motor time constant.</p></li>
</ul>
</li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">T</span><span class="o">=</span><span class="mf">1e-3</span>
<span class="n">TH</span><span class="o">=</span><span class="n">T</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">])</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1e-3</span>
<span class="n">t_end</span> <span class="o">=</span> <span class="mf">10e-3</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="k">for</span> <span class="n">THH</span> <span class="ow">in</span> <span class="n">TH</span><span class="p">:</span>
    <span class="n">simulationTest_motordc_timeSeries</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">THH</span><span class="p">,</span><span class="mi">100</span><span class="o">*</span><span class="n">THH</span><span class="o">/</span><span class="n">T</span><span class="p">,</span><span class="s1">&#39;pwm&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/project3_sim_simulation_26_0.png" src="../../_images/project3_sim_simulation_26_0.png" />
</div>
</div>
</section>
<section id="Simulation---time-series---PWM---long-time-scale-(seconds)">
<h2>Simulation - time series - PWM - long time scale (seconds)<a class="headerlink" href="#Simulation---time-series---PWM---long-time-scale-(seconds)" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Time vector: step 0.1 ms, end time 3 seconds</p></li>
<li><p>Applied voltage:</p>
<ul>
<li><p>0-5 V TTL PWM</p></li>
<li><p>PWM frqeuency f = 980 Hz</p></li>
<li><p>Duty cycle as parameter: 25%, 50%, 75%</p></li>
</ul>
</li>
<li><p>Results:</p>
<ul>
<li><p>The angular velocity increases linearly and then reaches its terminal value.</p></li>
<li><p>Both the rate of increase and the terminal values scale with the PWMs duty cycle.</p></li>
<li><p>The motors mechanical time constant <span class="math notranslate nohighlight">\(t_{mech}=\frac{J}{B}\)</span> governs the time time scale towards reaching final value.</p></li>
<li><p>At low load (low rotational inertia) the mechanical time constant is of order ~0.1 s.</p></li>
<li><p>When additional load attached, the rotational inertia increases, and so does the time constant.</p></li>
<li><p>Also the damping coefficient may vary, for example at very fast rotation (damping inverse to friction).</p></li>
<li><p>Current and Torque envelope shows slight variation over time.</p></li>
<li><p>While the amplitude is constant, a slight negative offset is noted at terminal velocity.</p></li>
</ul>
</li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">T</span><span class="o">=</span><span class="mf">1e-3</span>
<span class="n">TH</span><span class="o">=</span><span class="n">T</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">])</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1e-3</span>
<span class="n">t_end</span> <span class="o">=</span> <span class="mf">3000e-3</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="k">for</span> <span class="n">THH</span> <span class="ow">in</span> <span class="n">TH</span><span class="p">:</span>
    <span class="n">simulationTest_motordc_timeSeries</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">THH</span><span class="p">,</span><span class="mi">100</span><span class="o">*</span><span class="n">THH</span><span class="o">/</span><span class="n">T</span><span class="p">,</span><span class="s1">&#39;pwm&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/project3_sim_simulation_28_0.png" src="../../_images/project3_sim_simulation_28_0.png" />
</div>
</div>
</section>
<section id="Simulation---time-series---PWM---tstep-influence">
<h2>Simulation - time series - PWM - tstep influence<a class="headerlink" href="#Simulation---time-series---PWM---tstep-influence" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Time vector:</p>
<ul>
<li><p>end time 3 seconds</p></li>
<li><p>step varies: 0.02 ms, 0.1 ms, 0.2 ms</p></li>
</ul>
</li>
<li><p>Applied voltage:</p>
<ul>
<li><p>0-5 V TTL PWM</p></li>
<li><p>PWM frqeuency f = 980 Hz</p></li>
<li><p>Duty cycle: 10%</p></li>
</ul>
</li>
<li><p>Results:</p>
<ul>
<li><p>The resulting angular velocity is consistent as long as the numerical time step is well below the time cosntants of applied pwm voltage signal and the dystem (motor).</p></li>
<li><p>As a rule of thumb, a factor of 10 should be respected.</p></li>
<li><p>To simulate the full dynamic range of PWM, very small time steps are required.</p></li>
<li><p>Example: Arduino PWM ‘analogWrite()’ with 8bit resolution would need <span class="math notranslate nohighlight">\(dt= 1 ms / 2560 \approx 400 ns\)</span>.</p></li>
<li><p>Also the amplitude of Current and Torque become unreliable when step inadequately chosen.</p></li>
<li><p>The pwm time constant issue, if any, can be overcome using a DAC (digital analog converter) instead of PWM modulation.</p></li>
</ul>
</li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">T</span><span class="o">=</span><span class="mf">1e-3</span>
<span class="n">TH</span><span class="o">=</span><span class="n">T</span><span class="o">*</span><span class="mf">0.1</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.02</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>
<span class="n">t_end</span> <span class="o">=</span> <span class="mf">3000e-3</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="k">for</span> <span class="n">dtx</span> <span class="ow">in</span> <span class="n">dt</span><span class="p">:</span>
    <span class="n">simulationTest_motordc_timeSeries</span><span class="p">(</span><span class="n">dtx</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">TH</span><span class="p">,</span><span class="n">dtx</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span><span class="s1">&#39;pwm&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/project3_sim_simulation_30_0.png" src="../../_images/project3_sim_simulation_30_0.png" />
</div>
</div>
</section>
<section id="Simulation---transfer-curve---DAC-vs-PWM-sweep">
<h2>Simulation - transfer curve - DAC vs PWM sweep<a class="headerlink" href="#Simulation---transfer-curve---DAC-vs-PWM-sweep" title="Link to this heading"></a></h2>
<p>(not terminated, work in progress)</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Transfer curve function for DC motor simulator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="k">def</span><span class="w"> </span><span class="nf">simulationTest_motordc_transferCurve</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">dT</span><span class="p">,</span><span class="n">dTmeasure</span><span class="p">):</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t_end</span> <span class="o">+</span> <span class="n">dt</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>

    <span class="c1"># Number of steps</span>
    <span class="n">n_steps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">t_end</span> <span class="o">+</span> <span class="n">dt</span><span class="p">)</span> <span class="o">//</span> <span class="n">dT</span><span class="p">)</span>
    <span class="n">step_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Create stairway function</span>
    <span class="n">stairway</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">stair_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">dT</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span>
        <span class="n">stair_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dT</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span>
        <span class="n">stairway</span><span class="p">[</span><span class="n">stair_start</span><span class="p">:</span><span class="n">stair_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c1"># DC sweep</span>

    <span class="c1"># initialize start values</span>
    <span class="n">qr</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">qr_d</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">curr</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">curr_prev</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">curr_d</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="c1">#initialize output</span>
    <span class="n">wmm</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Vmm</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">V</span><span class="o">=</span><span class="n">stairway</span><span class="o">*</span><span class="mi">5</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)):</span>

        <span class="c1">#value = MotorDynamics(vx, dt)</span>
        <span class="n">vx</span> <span class="o">=</span> <span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="c1">#pwm</span>
        <span class="n">curr_d</span> <span class="o">=</span> <span class="p">(</span><span class="n">vx</span> <span class="o">-</span> <span class="n">qr_d</span> <span class="o">*</span> <span class="n">ke</span> <span class="o">-</span> <span class="n">R</span> <span class="o">*</span> <span class="n">curr</span><span class="p">)</span> <span class="o">/</span> <span class="n">L</span>
        <span class="n">curr</span> <span class="o">=</span> <span class="n">curr</span> <span class="o">+</span> <span class="n">curr_d</span> <span class="o">*</span> <span class="n">dt</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">curr</span> <span class="o">*</span> <span class="n">kt</span>
        <span class="n">qr_dd</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">B</span> <span class="o">*</span> <span class="n">qr_d</span><span class="p">)</span> <span class="o">/</span> <span class="n">J</span>
        <span class="n">qr_d</span> <span class="o">=</span> <span class="n">qr_d</span> <span class="o">+</span> <span class="n">qr_dd</span> <span class="o">*</span> <span class="n">dt</span>
        <span class="n">qr</span> <span class="o">=</span> <span class="n">qr</span> <span class="o">+</span> <span class="n">qr_d</span> <span class="o">*</span> <span class="n">dt</span>
        <span class="n">curr_prev</span> <span class="o">=</span> <span class="n">curr</span>
        <span class="c1">#if t(i) % T &lt; T*duty(i), 5, 0)</span>
        <span class="n">wmm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qr_d</span><span class="p">)</span>
        <span class="n">Vmm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span>

    <span class="n">wmm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">wmm</span><span class="p">)</span>
    <span class="n">Vmm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Vmm</span><span class="p">)</span>

    <span class="c1"># Top-left: Time series input (voltage)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Vmm</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;dc_sweep-time series&#39;</span><span class="p">)</span>
    <span class="c1">#  axs[0, 0].set_title(&#39;Applied (PWM)&#39;)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Voltage (V)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Bottom-left: Transfer curve (angular velocity)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Vmm</span><span class="p">,</span> <span class="n">wmm</span><span class="o">*</span><span class="mi">60</span><span class="o">/</span><span class="mf">6.28</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;dc_sweep&#39;</span><span class="p">)</span>
    <span class="c1">#   axs[1, 0].set_title(&#39;Transfer curve: \omega VS Va&#39;)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;rpm&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Voltage (V)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># PWM sweep</span>

    <span class="c1"># initialize start values</span>
    <span class="n">qr</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">qr_d</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">curr</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">curr_prev</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">curr_d</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="c1">#initialize output</span>
    <span class="n">wmm2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Vmm2</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">duty</span><span class="o">=</span><span class="n">stairway</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)):</span>

        <span class="c1">#value = MotorDynamics(vx, dt)</span>
        <span class="n">vx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span> <span class="n">T</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">T</span><span class="o">*</span><span class="n">duty</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1">#pwm</span>
        <span class="n">curr_d</span> <span class="o">=</span> <span class="p">(</span><span class="n">vx</span> <span class="o">-</span> <span class="n">qr_d</span> <span class="o">*</span> <span class="n">ke</span> <span class="o">-</span> <span class="n">R</span> <span class="o">*</span> <span class="n">curr</span><span class="p">)</span> <span class="o">/</span> <span class="n">L</span>
        <span class="n">curr</span> <span class="o">=</span> <span class="n">curr</span> <span class="o">+</span> <span class="n">curr_d</span> <span class="o">*</span> <span class="n">dt</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">curr</span> <span class="o">*</span> <span class="n">kt</span>
        <span class="n">qr_dd</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="n">B</span> <span class="o">*</span> <span class="n">qr_d</span><span class="p">)</span> <span class="o">/</span> <span class="n">J</span>
        <span class="n">qr_d</span> <span class="o">=</span> <span class="n">qr_d</span> <span class="o">+</span> <span class="n">qr_dd</span> <span class="o">*</span> <span class="n">dt</span>
        <span class="n">qr</span> <span class="o">=</span> <span class="n">qr</span> <span class="o">+</span> <span class="n">qr_d</span> <span class="o">*</span> <span class="n">dt</span>
        <span class="n">curr_prev</span> <span class="o">=</span> <span class="n">curr</span>
        <span class="c1">#if t(i) % T &lt; T*duty(i), 5, 0)</span>
        <span class="n">wmm2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qr_d</span><span class="p">)</span>
        <span class="n">Vmm2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span>

    <span class="n">wmm2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">wmm</span><span class="p">)</span>
    <span class="n">Vmm2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Vmm</span><span class="p">)</span>

    <span class="c1"># Top-right: Time series input (voltage)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">duty</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;pwm_sweep-time series&#39;</span><span class="p">)</span>
 <span class="c1">#   axs[0, 1].set_title(&#39;Applied (PWM)&#39;)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (s)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Duty-cycle (%)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Bottom-right: Transfer curve (angular velocity)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">duty</span><span class="p">,</span> <span class="n">wmm2</span><span class="o">*</span><span class="mi">60</span><span class="o">/</span><span class="mf">6.28</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;pwm_sweep&#39;</span><span class="p">)</span>
  <span class="c1">#  axs[1, 1].set_title(&#39;Transfer curve: \omega VS Va&#39;)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;rpm&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;pwm duty-cycle (%)&#39;</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="n">T</span><span class="o">=</span><span class="mf">1e-3</span>
<span class="n">dT</span><span class="o">=</span><span class="mi">100</span><span class="o">*</span><span class="n">T</span>
<span class="n">dTmeasure</span><span class="o">=</span><span class="n">dT</span><span class="p">;</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1e-3</span>
<span class="n">t_end</span> <span class="o">=</span> <span class="mf">1000e-3</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">simulationTest_motordc_transferCurve</span><span class="p">(</span><span class="n">dtx</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="n">dT</span><span class="p">,</span><span class="n">dTmeasure</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/project3_sim_simulation_32_0.png" src="../../_images/project3_sim_simulation_32_0.png" />
</div>
</div>
</section>
<section id="Simulation---DC-motor---torque/speed-curves">
<h2>Simulation - DC motor - torque/speed curves<a class="headerlink" href="#Simulation---DC-motor---torque/speed-curves" title="Link to this heading"></a></h2>
<p>(not terminated, work in progress)</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">resetInitialState</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
</section>
<section id="DC-motor-with-wheel-simulation">
<h2>DC motor with wheel simulation<a class="headerlink" href="#DC-motor-with-wheel-simulation" title="Link to this heading"></a></h2>
</section>
<section id="Pendulum-simulation">
<h2>Pendulum simulation<a class="headerlink" href="#Pendulum-simulation" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">Forwardkinematics</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">L2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">L2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>

<span class="k">def</span><span class="w"> </span><span class="nf">PendulumEnergy</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
    <span class="n">K</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">m1</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">qp_d</span> <span class="o">*</span> <span class="n">L1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="o">+</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">m2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">qp_d</span> <span class="o">*</span> <span class="n">L2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="o">+</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">J</span> <span class="o">*</span> <span class="n">qp_d</span> <span class="o">*</span> <span class="n">qp_d</span><span class="p">)</span>
        <span class="o">+</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">I1</span> <span class="o">*</span> <span class="n">qp_d</span> <span class="o">*</span> <span class="n">qp_d</span><span class="p">)</span>
    <span class="p">)</span>  <span class="c1"># Kinetic energy</span>
    <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="n">m1</span> <span class="o">+</span> <span class="n">m2</span><span class="p">)</span> <span class="o">*</span> <span class="n">g</span> <span class="o">*</span> <span class="n">L2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>  <span class="c1"># Potential energy</span>
    <span class="k">return</span> <span class="n">K</span> <span class="o">+</span> <span class="n">P</span>
<br/></pre></div>
</div>
</div>
</section>
<section id="Sensor-simulation">
<h2>Sensor simulation<a class="headerlink" href="#Sensor-simulation" title="Link to this heading"></a></h2>
</section>
<section id="Controller-simulation">
<h2>Controller simulation<a class="headerlink" href="#Controller-simulation" title="Link to this heading"></a></h2>
</section>
</section>
<section id="Controller-model">
<h1>Controller model<a class="headerlink" href="#Controller-model" title="Link to this heading"></a></h1>
<section id="Controllers">
<h2>Controllers<a class="headerlink" href="#Controllers" title="Link to this heading"></a></h2>
<ul>
<li><p><strong>LQR Controller</strong>: A linear quadratic regulator designed to stabilize the pendulum in the upright position.</p>
<p>#### Linearization dynamics model ####</p>
<ul>
<li><p><strong>Part RWIP</strong></p>
<p>when sinθp -&gt; 0 sinθp = θp</p>
</li>
</ul>
<p>    <span class="math notranslate nohighlight">\(\ddot{\theta_p} = \frac{m_{1}gL_{1}\theta_{p}\ +\ m_{2}gL_{2}\theta_{p}\ -\ T_{m} +\ T_{d}}{m_{1}L_{1}^{2}+m_{2}L_{2}^{2}+I_{1}}\)</span></p>
<p>    <span class="math notranslate nohighlight">\(\ddot{\theta_r} = \frac{T_{m}}{I_{2}}-\frac{m_{1}gL_{1}\ +\ m_{2}gL_{2}\ -\ T_{m} +\ T_{d}}{m_{1}L_{1}^{2}+m_{2}L_{2}^{2}+I_{1}}\)</span></p>
<ul class="simple">
<li><p><strong>Part Motor</strong></p></li>
</ul>
<p>   We can estimate that L &lt;&lt; R</p>
<p>    <span class="math notranslate nohighlight">\(Vin = R i + k_e θ_r\)</span></p>
<p>    <span class="math notranslate nohighlight">\(T_{m} = k_t i\)</span></p>
</li>
</ul>
<p>#### State space ####</p>
<p>The proceeding equations are valid around the operating point where θp = 0</p>
<p>      <img alt="Matrix" src="https://latex.codecogs.com/svg.image?%5Cbegin%7Bbmatrix%7D%5Cdot%7B%5Ctheta_p%7D%5C%5C%5Cddot%7B%5Ctheta_p%7D%5C%5C%5Cdot%7B%5Ctheta_r%7D%5C%5C%5Cddot%7B%5Ctheta_r%7D%5Cend%7Bbmatrix%7D=%5Cbegin%7Bbmatrix%7D0&amp;1&amp;0&amp;0%5C%5C%5Cfrac%7B(m_1L_1+m_2L_2)g%7D%7Bm_1L_1%5E%7B2%7D+m_2L_2%5E%7B2%7D+J%7D&amp;0&amp;0&amp;%5Cfrac%7Bk_tk_e%7D%7B(m_1L_1%5E%7B2%7D+m_2L_2%5E%7B2%7D+J)R%7D%5C%5C0&amp;0&amp;0&amp;1%5C%5C-%5Cfrac%7B(m_1L_1+m_2L_2)g%7D%7Bm_1L_1%5E%7B2%7D+m_2L_2%5E%7B2%7D+J%7D&amp;0&amp;0&amp;-(%5Cfrac%7Bm_1L_1%5E%7B2%7D+m_2L_2%5E%7B2%7D+2J%7D%7B(m_1L_1%5E%7B2%7D+m_2L_2%5E%7B2%7D+J)J%7D)(%5Cfrac%7Bk_tk_e%7D%7BR%7D)%5C%5C%5Cend%7Bbmatrix%7D%5Cbegin%7Bbmatrix%7D%5Ctheta_p%5C%5C%5Cdot%7B%5Ctheta_p%7D%5C%5C%5Ctheta_r%5C%5C%5Cdot%7B%5Ctheta_r%7D%5Cend%7Bbmatrix%7D+%5Cbegin%7Bbmatrix%7D0%5C%5C%5Cfrac%7Bk_t%7D%7B(m_1L_1%5E%7B2%7D+m_2L_2%5E%7B2%7D+J)R%7D%5C%5C0%5C%5C(%5Cfrac%7Bm_1L_1%5E%7B2%7D+m_2L_2%5E%7B2%7D+2J%7D%7B(m_1L_1%5E%7B2%7D+m_2L_2%5E%7B2%7D+J)J%7D)(%5Cfrac%7Bkt%7D%7BR%7D)%5Cend%7Bbmatrix%7DV_%7Bin%7D" /></p>
<ul>
<li><p><strong>PID Controller</strong>: The stabilize controller to compare with LQR #### Transfer function ####</p>
<p>    <span class="math notranslate nohighlight">\(\Large\frac{\theta_{p}(s)}{\tau_{m}(s)}=\frac{\frac{s}{-J-m_{2}L_{2}^{2}}}{s^{3}+\left(\frac{B}{I_{1}}+\frac{B+d_{p}}{J+m_{2}L_{2}^{2}}\right)s^{2}-\left(\frac{\left(m_{1}L_{1}+m_{2}L_{2}\right)g}{\left(J+m_{2}L_{2}^{2}\right)I_{1}}-\frac{B\cdot d_{p}}{\left(J+m_{2}L_{2}^{2}\right)I_{1}}\right)s-\frac{\left(m_{1}L_{1}+m_{2}L_{2}\right)Bg}{\left(J+m_{2}L_{2}^{2}\right)I_{1}}}\)</span></p>
</li>
<li><p><strong>Bang-bang Controller</strong>: The swing up control routine and the stabilizing control routine are switched between -25 to 25 degree</p></li>
</ul>
<p>   <img alt="c4fffdb80f874eed887064f35f631e50" class="no-scaled-link" src="https://github.com/B-Paweekorn/Reaction-wheel-inverted-pendulum/assets/122732439/79e6d6d3-9ab2-49eb-a58b-3ad10a96a96b" style="width: 480px;" /></p>
<ul class="simple">
<li><p><strong>Brake Controller</strong>: Used as reduced energy of RWIP when RWIP have too much energy for stabilze</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># LQR parameter</span>
<span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">m1</span> <span class="o">*</span> <span class="n">L1</span> <span class="o">*</span> <span class="n">L1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">m2</span> <span class="o">*</span> <span class="n">L2</span> <span class="o">*</span> <span class="n">L2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">I1</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">m1</span> <span class="o">*</span> <span class="n">L1</span> <span class="o">+</span> <span class="n">m2</span> <span class="o">*</span> <span class="n">L2</span><span class="p">)</span> <span class="o">*</span> <span class="n">g</span>

<span class="n">a21</span> <span class="o">=</span> <span class="n">b</span><span class="o">/</span><span class="n">a</span>
<span class="n">a24</span> <span class="o">=</span> <span class="p">(</span><span class="n">kt</span> <span class="o">*</span> <span class="n">ke</span> <span class="o">*</span> <span class="n">Ng</span> <span class="o">*</span> <span class="n">Ng</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">R</span><span class="p">)</span>
<span class="n">a41</span> <span class="o">=</span> <span class="o">-</span><span class="n">b</span><span class="o">/</span><span class="n">a</span>
<span class="n">a44</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">J</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">kt</span> <span class="o">*</span> <span class="n">ke</span> <span class="o">*</span> <span class="n">Ng</span> <span class="o">*</span> <span class="n">Ng</span><span class="p">)</span> <span class="o">/</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">J</span> <span class="o">*</span> <span class="n">R</span><span class="p">)</span>

<span class="n">b2</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">kt</span><span class="o">*</span><span class="n">Ng</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">R</span><span class="p">)</span>
<span class="n">b4</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">J</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">kt</span> <span class="o">*</span> <span class="n">Ng</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">J</span> <span class="o">*</span> <span class="n">R</span><span class="p">)</span>

<span class="n">A_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                     <span class="p">[</span><span class="n">a21</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a24</span><span class="p">],</span>
                     <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                     <span class="p">[</span><span class="n">a41</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">a44</span><span class="p">]])</span>

<span class="n">B_Matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span>
                     <span class="p">[</span><span class="n">b2</span><span class="p">],</span>
                     <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                     <span class="p">[</span><span class="n">b4</span><span class="p">]])</span>

<span class="n">desired_poles</span> <span class="o">=</span> <span class="p">[]</span>
<br/></pre></div>
</div>
</div>
</section>
<section id="System-(Plant)-simulation">
<h2>System (Plant) simulation<a class="headerlink" href="#System-(Plant)-simulation" title="Link to this heading"></a></h2>
<p>Mathematical model of RWIP:</p>
<p><span class="math notranslate nohighlight">\(\ddot{\theta_p} = \frac{m_{1}gL_{1}\sin\left(\theta_{p}\right)\ +\ m_{2}gL_{2}\sin\left(\theta_{p}\right)\ -\ T_{m} +\ T_{d}}{m_{1}L_{1}^{2}+m_{2}L_{2}+I_{1}}\)</span></p>
<p><span class="math notranslate nohighlight">\(\ddot{\theta_r} = \frac{T_{r}}{I_{2}}-\frac{m_{1}gL_{1}\ +\ m_{2}gL_{2}-T_{m} +\ T_{d}}{m_{1}L_{1}^{2}+m_{2}L_{2}+I_{1}}\)</span></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">RwipDynamics</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">Tr</span><span class="p">,</span> <span class="n">Tp</span><span class="p">):</span>
    <span class="n">qdd</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">m1</span> <span class="o">*</span> <span class="n">g</span> <span class="o">*</span> <span class="n">L1</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">q</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">m2</span> <span class="o">*</span> <span class="n">g</span> <span class="o">*</span> <span class="n">L2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">q</span><span class="p">))</span> <span class="o">-</span> <span class="n">Tr</span> <span class="o">+</span> <span class="n">Tp</span> <span class="o">-</span> <span class="n">dp</span> <span class="o">*</span> <span class="n">qp_d</span>
    <span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">m1</span> <span class="o">*</span> <span class="n">L1</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">m2</span> <span class="o">*</span> <span class="n">L2</span><span class="p">)</span> <span class="o">+</span> <span class="n">I1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">qdd</span>
<br/></pre></div>
</div>
</div>
</section>
<section id="Set-up-the-system-simulator">
<h2>Set up the system simulator<a class="headerlink" href="#Set-up-the-system-simulator" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pygame</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pygame.locals</span><span class="w"> </span><span class="kn">import</span> <span class="n">QUIT</span><span class="p">,</span> <span class="n">MOUSEBUTTONDOWN</span><span class="p">,</span> <span class="n">KEYDOWN</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt5.QtWidgets</span><span class="w"> </span><span class="kn">import</span> <span class="n">QApplication</span><span class="p">,</span> <span class="n">QMainWindow</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt5.QtCore</span><span class="w"> </span><span class="kn">import</span> <span class="n">Qt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.backends.backend_qt5agg</span><span class="w"> </span><span class="kn">import</span> <span class="n">FigureCanvasQTAgg</span> <span class="k">as</span> <span class="n">FigureCanvas</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pygetwindow</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">gw</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pyaudio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">control</span>
<span class="c1">#import source.content.project3.code.thai.param as param  #only required when using param.py file</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
pygame 2.6.1 (SDL 2.28.4, Python 3.13.3)
Hello from the pygame community. https://www.pygame.org/contribute.html
</pre></div></div>
</div>
</section>
<section id="Visualization">
<h2>Visualization<a class="headerlink" href="#Visualization" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_figure</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">qp</span><span class="p">,</span> <span class="n">qp_d</span><span class="p">,</span> <span class="n">qr_d</span><span class="p">,</span> <span class="n">Tm</span><span class="p">,</span> <span class="n">Vin</span><span class="p">,</span> <span class="n">Tp</span><span class="p">,</span> <span class="n">setpoint</span><span class="p">):</span>
    <span class="n">x_offset</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">y_offset</span> <span class="o">=</span> <span class="mi">360</span>
    <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="c1"># Draw RWIP</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">Forwardkinematics</span><span class="p">(</span><span class="n">qp</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">x_offset</span> <span class="o">-</span> <span class="n">x</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">,</span> <span class="n">y_offset</span> <span class="o">-</span> <span class="n">y</span> <span class="o">*</span> <span class="n">multiplier</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">,</span> <span class="p">(</span><span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>

    <span class="c1"># Draw wheel</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">GREY</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">wheelradius</span> <span class="o">*</span> <span class="n">multiplier</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

    <span class="c1"># Draw cross</span>
    <span class="n">cross_length</span> <span class="o">=</span> <span class="n">wheelradius</span> <span class="o">*</span> <span class="n">multiplier</span>
    <span class="n">cross_dx</span> <span class="o">=</span> <span class="n">cross_length</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">qr</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span>
    <span class="n">cross_dy</span> <span class="o">=</span> <span class="o">-</span><span class="n">cross_length</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">qr</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.8</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
        <span class="n">screen</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">cross_dx</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">cross_dy</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">cross_dx</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">cross_dy</span><span class="p">),</span> <span class="mi">2</span>
    <span class="p">)</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
        <span class="n">screen</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">cross_dy</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">cross_dx</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">cross_dy</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">cross_dx</span><span class="p">),</span> <span class="mi">2</span>
    <span class="p">)</span>

    <span class="c1"># Draw pendulum point</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">circle</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">,</span> <span class="p">(</span><span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>

    <span class="c1"># Draw text</span>
    <span class="n">font</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">font</span><span class="o">.</span><span class="n">Font</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">18</span><span class="p">)</span>
    <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s2">&quot;Setpoint (deg): </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">setpoint</span><span class="p">),</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;Pendulum Angle (deg): </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">qp</span><span class="p">),</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;Pendulum Speed (deg/s) : </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">qp_d</span><span class="p">),</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;Controller Mode : </span><span class="si">{</span><span class="n">controller_mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">text</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">texts</span><span class="p">):</span>
        <span class="n">rendered_text</span> <span class="o">=</span> <span class="n">font</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">)</span>
        <span class="n">screen</span><span class="o">.</span><span class="n">blit</span><span class="p">(</span><span class="n">rendered_text</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">80</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">20</span><span class="p">))</span>

    <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s2">&quot;Motorspeed (RPM): </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">qr_d</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;Apply Torque (Nm): </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">Tm</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;Vin (V): </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">Vin</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">text</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">texts</span><span class="p">):</span>
        <span class="n">rendered_text</span> <span class="o">=</span> <span class="n">font</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">)</span>
        <span class="n">screen</span><span class="o">.</span><span class="n">blit</span><span class="p">(</span><span class="n">rendered_text</span><span class="p">,</span> <span class="p">(</span><span class="mi">230</span><span class="p">,</span> <span class="mi">80</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">20</span><span class="p">))</span>

    <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s2">&quot;FUEL: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">controller_energy</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;TIME: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">controller_time</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">text</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">texts</span><span class="p">):</span>
        <span class="n">rendered_text</span> <span class="o">=</span> <span class="n">font</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">BLACK</span><span class="p">)</span>
        <span class="n">screen</span><span class="o">.</span><span class="n">blit</span><span class="p">(</span><span class="n">rendered_text</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">170</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">20</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">plot_graph</span><span class="p">():</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

    <span class="c1"># Create the first subplot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timedt_data</span><span class="p">,</span> <span class="n">qp_data</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;qp&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timedt_data</span><span class="p">,</span> <span class="n">setpoint_data</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;setpoint&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="c1"># Create the second subplot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timedt_data</span><span class="p">,</span> <span class="n">qr_d_data</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;qr_d&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;purple&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timedt_data</span><span class="p">,</span> <span class="n">Tm_data</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Tm&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>

    <span class="c1"># Display the figure</span>
    <span class="n">canvas</span> <span class="o">=</span> <span class="n">FigureCanvas</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
    <span class="n">win</span><span class="o">.</span><span class="n">setCentralWidget</span><span class="p">(</span><span class="n">canvas</span><span class="p">)</span>
    <span class="n">win</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">on_click</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="n">plot_graph</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
</section>
<section id="Sound-(optional)">
<h2>Sound (optional)<a class="headerlink" href="#Sound-(optional)" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pyaudio</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">pyaudio</span><span class="o">.</span><span class="n">PyAudio</span><span class="p">()</span>
<span class="n">BITRATE</span> <span class="o">=</span> <span class="mi">90000</span>  <span class="c1"># number of frames per second/frameset.</span>
<span class="n">FREQUENCY</span> <span class="o">=</span> <span class="mi">2000</span>  <span class="c1"># Hz, waves per second, 261.63=C4-note.</span>
<span class="n">BITRATE</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">BITRATE</span><span class="p">,</span> <span class="n">FREQUENCY</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">stream</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">get_format_from_width</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">rate</span><span class="o">=</span><span class="n">BITRATE</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">stop_thread</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">def</span><span class="w"> </span><span class="nf">generate_sound</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate and play sound with current frequency in a loop.&quot;&quot;&quot;</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">stop_thread</span><span class="p">:</span>
        <span class="c1"># Generate wave data for 1 second</span>
        <span class="n">NUMBEROFFRAMES</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">BITRATE</span> <span class="o">*</span> <span class="mf">0.0002</span><span class="p">)</span>  <span class="c1"># 1 second of sound</span>
        <span class="n">WAVEDATA</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUMBEROFFRAMES</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">WAVEDATA</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="p">((</span><span class="n">BITRATE</span> <span class="o">/</span> <span class="n">FREQUENCY</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">*</span> <span class="mi">127</span> <span class="o">+</span> <span class="mi">128</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ZeroDivisionError</span><span class="p">:</span>
                <span class="n">WAVEDATA</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
        <span class="c1"># Play sound</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">WAVEDATA</span><span class="p">)</span>

<span class="c1"># Start sound generation in a separate thread</span>
<span class="n">sound_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">generate_sound</span><span class="p">)</span>
<span class="c1">#if param.Sound:</span>
<span class="k">if</span> <span class="n">Sound</span><span class="p">:</span>
    <span class="n">sound_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
</section>
<section id="Run-the-simulator">
<h2>Run the simulator<a class="headerlink" href="#Run-the-simulator" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>    <span class="c1"># Initial state</span>

    <span class="n">init_qp</span> <span class="o">=</span> <span class="mf">180.0</span>  <span class="c1"># Initial pendulum angle (degree)</span>
    <span class="n">init_qp_d</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Initial pendulum speed</span>

    <span class="n">init_qr</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Initial reaction wheel angle</span>
    <span class="n">init_qr_d</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Initial reaction wheel speed</span>

    <span class="n">init_Tm</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Initial reaction wheel torque</span>
    <span class="n">init_Tp</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># Initial disturbance torque</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="c1"># ==========================================================================================</span>
<span class="c1"># ======================================= MAIN LOGIC =======================================</span>
<span class="c1"># ==========================================================================================</span>
<span class="n">qp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">init_qp</span><span class="p">)</span>
<span class="n">qp_d</span> <span class="o">=</span> <span class="n">init_qp_d</span>

<span class="n">qr</span> <span class="o">=</span> <span class="n">init_qr</span>  <span class="c1"># Initial reaction wheel angle</span>
<span class="n">qr_d</span> <span class="o">=</span> <span class="n">init_qr_d</span>  <span class="c1"># Initial reaction wheel speed</span>

<span class="n">curr_prev</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">curr_d</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">Tm</span> <span class="o">=</span> <span class="n">init_Tm</span>  <span class="c1"># Initial reaction wheel torque</span>
<span class="n">Tp</span> <span class="o">=</span> <span class="n">init_Tp</span>  <span class="c1"># Initial disturbance torque</span>

<span class="n">controller_stat_flag</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">controller_stat_flag_last</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">controller_time</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">controller_energy</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">timedt</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">100</span>  <span class="c1"># frequency (Hz)</span>

<span class="n">reqE</span> <span class="o">=</span> <span class="p">(</span><span class="n">m1</span> <span class="o">+</span> <span class="n">m2</span><span class="p">)</span> <span class="o">*</span> <span class="n">g</span> <span class="o">*</span> <span class="n">L2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="n">setpoint</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># do not adjust</span>

<span class="c1"># For LQR control</span>
<span class="n">K</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">E</span> <span class="o">=</span> <span class="n">control</span><span class="o">.</span><span class="n">lqr</span><span class="p">(</span><span class="n">A_matrix</span><span class="p">,</span> <span class="n">B_Matrix</span><span class="p">,</span> <span class="n">Q_LQR</span><span class="p">,</span> <span class="n">R_LQR</span><span class="p">,</span> <span class="n">N_LQR</span><span class="p">)</span>

<span class="c1"># For PID control</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">control</span><span class="o">.</span><span class="n">TransferFunction</span><span class="o">.</span><span class="n">s</span>
<span class="n">G</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">/</span><span class="p">(</span><span class="o">-</span><span class="n">J</span><span class="o">-</span><span class="n">m1</span><span class="o">*</span><span class="n">L1</span><span class="o">*</span><span class="n">L1</span><span class="p">))</span><span class="o">/</span><span class="p">((</span><span class="n">s</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="p">((</span><span class="n">B</span><span class="o">/</span><span class="n">I1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">B</span> <span class="o">+</span> <span class="n">dp</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">m2</span><span class="o">*</span><span class="n">L2</span><span class="o">*</span><span class="n">L2</span><span class="p">))</span><span class="o">*</span><span class="n">s</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="p">((</span><span class="n">m1</span><span class="o">*</span><span class="n">L1</span> <span class="o">+</span> <span class="n">m2</span><span class="o">*</span><span class="n">L2</span><span class="p">)</span><span class="o">*</span><span class="n">g</span><span class="o">/</span><span class="p">((</span><span class="n">J</span> <span class="o">+</span> <span class="n">m2</span><span class="o">*</span><span class="n">L2</span><span class="o">*</span><span class="n">L2</span><span class="p">)</span><span class="o">*</span><span class="n">I1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">B</span> <span class="o">+</span> <span class="n">dp</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="n">J</span><span class="o">+</span><span class="n">m2</span><span class="o">*</span><span class="n">L2</span><span class="o">*</span><span class="n">L2</span><span class="p">)</span><span class="o">*</span><span class="n">I1</span><span class="p">))</span><span class="o">*</span><span class="n">s</span> <span class="o">-</span> <span class="p">(</span><span class="n">m1</span><span class="o">*</span><span class="n">L1</span> <span class="o">+</span> <span class="n">m2</span><span class="o">*</span><span class="n">L2</span><span class="p">)</span><span class="o">*</span><span class="n">B</span><span class="o">*</span><span class="n">g</span><span class="o">/</span><span class="p">((</span><span class="n">J</span><span class="o">+</span><span class="n">m2</span><span class="o">*</span><span class="n">L2</span><span class="o">*</span><span class="n">L2</span><span class="p">)</span><span class="o">*</span><span class="n">I1</span><span class="p">)))</span>
<span class="n">C</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">s</span>

<span class="c1"># Plot the root locus</span>
<span class="k">if</span> <span class="n">Stabilize_Controller</span> <span class="o">==</span> <span class="s2">&quot;PID&quot;</span> <span class="ow">and</span> <span class="n">plot_rootlocus</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PID Mode&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting for root locus ...&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
    <span class="n">control</span><span class="o">.</span><span class="n">rlocus</span><span class="p">(</span><span class="n">C</span><span class="o">*</span><span class="n">G</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Systemzero: &quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">.</span><span class="n">zero</span><span class="p">(</span><span class="n">G</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Systempoles: &quot;</span><span class="p">,</span> <span class="n">control</span><span class="o">.</span><span class="n">pole</span><span class="p">(</span><span class="n">G</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Root Locus Plot&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Re&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Im&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initialize simulation&quot;</span><span class="p">)</span>


<span class="n">d_flag</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">settled_flag</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">wait_flag</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">input_flag</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">input_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;wsim=[]</span>
<span class="sd">tsim=[]</span>
<span class="sd">    wsim.append(wsim)</span>
<span class="sd">    tsim.append(tsim)</span>
<span class="sd">wsim = np.array(wsim)</span>
<span class="sd">tsim = np.array(tsim)&quot;&quot;&quot;</span>

<span class="n">pygame</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

<span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">560</span>
<span class="n">screen</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">set_mode</span><span class="p">((</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
<span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">set_caption</span><span class="p">(</span><span class="s2">&quot;Reaction Wheel Inverted Pendulum&quot;</span><span class="p">)</span>
<span class="n">pygame_windows</span> <span class="o">=</span> <span class="n">gw</span><span class="o">.</span><span class="n">getWindowsWithTitle</span><span class="p">(</span><span class="s2">&quot;Reaction Wheel Inverted Pendulum&quot;</span><span class="p">)</span>

<span class="n">WHITE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
<span class="n">GREY</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">RED</span> <span class="o">=</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">BLACK</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">font</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">font</span><span class="o">.</span><span class="n">Font</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">36</span><span class="p">)</span>
<span class="n">clock</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">Clock</span><span class="p">()</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">QApplication</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
<span class="n">win</span> <span class="o">=</span> <span class="n">QMainWindow</span><span class="p">()</span>
<span class="n">win</span><span class="o">.</span><span class="n">setWindowFlag</span><span class="p">(</span><span class="n">Qt</span><span class="o">.</span><span class="n">FramelessWindowHint</span><span class="p">)</span>  <span class="c1"># Remove the title bar</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="s2">&quot;plot output&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="s2">&quot;Click on the pendulum display to plot.</span><span class="se">\n\n</span><span class="s2">Don&#39;t spam, it lags.&quot;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">canvas</span> <span class="o">=</span> <span class="n">FigureCanvas</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
<span class="n">win</span><span class="o">.</span><span class="n">setCentralWidget</span><span class="p">(</span><span class="n">canvas</span><span class="p">)</span>
<span class="n">win</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;button_press_event&#39;</span><span class="p">,</span> <span class="n">on_click</span><span class="p">)</span>

<span class="c1">#variable initialization</span>
<span class="n">timedt_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">qp_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">setpoint_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">Tm_data</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">qr_d_data</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">while</span> <span class="n">running</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">pygame</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">QUIT</span><span class="p">:</span>  <span class="c1">#close event</span>
            <span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">MOUSEBUTTONDOWN</span><span class="p">:</span> <span class="c1">#reset event</span>
            <span class="k">if</span> <span class="mi">10</span> <span class="o">&lt;</span> <span class="n">event</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">110</span> <span class="ow">and</span> <span class="mi">10</span> <span class="o">&lt;</span> <span class="n">event</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">:</span>
                <span class="n">input_flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="mi">292</span> <span class="o">&lt;</span> <span class="n">event</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">392</span> <span class="ow">and</span> <span class="mi">10</span> <span class="o">&lt;</span> <span class="n">event</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">:</span>
                <span class="n">qp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">init_qp</span><span class="p">)</span>
                <span class="n">qp_d</span> <span class="o">=</span> <span class="n">init_qp_d</span>
                <span class="n">qr</span> <span class="o">=</span> <span class="n">init_qr</span>
                <span class="n">qr_d</span> <span class="o">=</span> <span class="n">init_qr_d</span>
                <span class="n">Tm</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">Tp</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">settled_flag</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">wait_flag</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">timedt</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">timedt_data</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">qp_data</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">setpoint_data</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">Tm_data</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">qr_d_data</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">controller_time</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">controller_energy</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">160</span><span class="p">:</span>
                <span class="n">plot_graph</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">KEYDOWN</span><span class="p">:</span>  <span class="c1">#not sure what event</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="n">pygame</span><span class="o">.</span><span class="n">K_BACKSPACE</span><span class="p">:</span>
                <span class="n">input_string</span> <span class="o">=</span> <span class="n">input_string</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="n">pygame</span><span class="o">.</span><span class="n">K_RETURN</span><span class="p">:</span>
                <span class="n">input_flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">input_string</span> <span class="o">+=</span> <span class="n">event</span><span class="o">.</span><span class="n">unicode</span>

    <span class="k">if</span> <span class="n">input_flag</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>  <span class="c1">#event: inject external perturbation torque Tp</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">Tp</span> <span class="o">=</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">input_string</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">Tp</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">input_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">input_flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Tp</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># ==========================================================================================</span>
    <span class="c1"># ======================================= Controller =======================================</span>
    <span class="c1"># ==========================================================================================</span>
    <span class="n">setpoint_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">qp</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="c1">#why ?</span>
    <span class="k">if</span> <span class="n">setpoint_offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">setpoint</span> <span class="o">=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">setpoint_offset</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">elif</span> <span class="n">setpoint_offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">setpoint</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">setpoint_offset</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span>
    <span class="c1">#well: would be more convenient to fold the phase</span>

    <span class="n">E</span> <span class="o">=</span> <span class="n">PendulumEnergy</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">qp</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">wait_flag</span><span class="p">:</span>
        <span class="n">controller_mode</span> <span class="o">=</span> <span class="s2">&quot;brake&quot;</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">E</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>   <span class="c1">#should be a parameter</span>
            <span class="n">wait_flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">qp</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">StabilizeBound</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">qp</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mi">360</span> <span class="o">-</span> <span class="n">StabilizeBound</span><span class="p">):</span>
        <span class="n">settled_flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">controller_mode</span> <span class="o">=</span> <span class="n">Stabilize_Controller</span>
        <span class="n">controller_stat_flag</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">settled_flag</span><span class="p">:</span>
            <span class="n">wait_flag</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">settled_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wait_flag</span><span class="p">:</span>
            <span class="n">controller_mode</span> <span class="o">=</span> <span class="s2">&quot;Bang-bang&quot;</span>

    <span class="k">if</span> <span class="n">controller_mode</span> <span class="o">==</span> <span class="s2">&quot;LQR&quot;</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">setpoint</span> <span class="o">-</span> <span class="n">qp</span>
        <span class="n">Vin</span> <span class="o">=</span> <span class="n">e</span> <span class="o">*</span> <span class="n">K</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">qp_d</span> <span class="o">*</span> <span class="o">-</span><span class="n">K</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">controller_mode</span> <span class="o">==</span> <span class="s2">&quot;PID&quot;</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">setpoint</span> <span class="o">-</span> <span class="n">qp</span>
        <span class="n">Vin</span> <span class="o">=</span> <span class="o">-</span><span class="n">e</span> <span class="o">*</span> <span class="n">Kp</span>
    <span class="k">elif</span> <span class="n">controller_mode</span> <span class="o">==</span> <span class="s2">&quot;Bang-bang&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">qp_d</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">E</span> <span class="o">&lt;</span> <span class="n">reqE</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">qp_d</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">E</span> <span class="o">&gt;=</span> <span class="n">reqE</span><span class="p">):</span>
            <span class="n">Vin</span> <span class="o">=</span> <span class="mi">9</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">qp_d</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">E</span> <span class="o">&lt;</span> <span class="n">reqE</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">qp_d</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">E</span> <span class="o">&gt;=</span> <span class="n">reqE</span><span class="p">):</span>
            <span class="n">Vin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Vin</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">elif</span> <span class="n">controller_mode</span> <span class="o">==</span> <span class="s2">&quot;brake&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">qp_d</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Vin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9</span>
        <span class="k">elif</span> <span class="n">qp_d</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Vin</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">Vin</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">MotorLimit</span><span class="p">:</span>
        <span class="c1"># Actual Limit</span>
        <span class="k">if</span> <span class="n">Vin</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">:</span>
            <span class="n">Vin</span> <span class="o">=</span> <span class="mi">9</span>
        <span class="k">elif</span> <span class="n">Vin</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">9</span><span class="p">:</span>
            <span class="n">Vin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9</span>

    <span class="n">Tm</span> <span class="o">=</span> <span class="n">MotorDynamics</span><span class="p">(</span><span class="n">Vin</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">FREQUENCY</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">qr_d</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">qp_dd</span> <span class="o">=</span> <span class="n">RwipDynamics</span><span class="p">(</span><span class="n">qp</span><span class="p">,</span> <span class="n">Tm</span><span class="p">,</span> <span class="n">Tp</span><span class="p">)</span>
    <span class="n">qp_d</span> <span class="o">=</span> <span class="n">qp_d</span> <span class="o">+</span> <span class="p">(</span><span class="n">qp_dd</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">qp</span> <span class="o">=</span> <span class="n">qp</span> <span class="o">+</span> <span class="p">(</span><span class="n">qp_d</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span>

    <span class="c1"># Draw background</span>
    <span class="n">screen</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">WHITE</span><span class="p">)</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">rect</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">401</span><span class="p">,</span> <span class="mi">160</span><span class="p">))</span>

    <span class="c1"># Draw grid</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">401</span><span class="p">,</span> <span class="mi">50</span><span class="p">):</span>
        <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">GREY</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">160</span><span class="p">),</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">600</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">160</span><span class="p">,</span> <span class="mi">560</span><span class="p">,</span> <span class="mi">50</span><span class="p">):</span>
        <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">GREY</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="p">(</span><span class="mi">400</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Draw figure</span>
    <span class="n">plot_figure</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">qp</span><span class="p">,</span> <span class="n">qp_d</span><span class="p">,</span> <span class="n">qr_d</span><span class="p">,</span> <span class="n">Tm</span><span class="p">,</span> <span class="n">Vin</span><span class="p">,</span> <span class="n">Tp</span><span class="p">,</span> <span class="n">setpoint</span><span class="p">)</span>
    <span class="n">timedt_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">timedt</span><span class="p">)</span>
    <span class="n">qp_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qp</span><span class="p">)</span>
    <span class="n">setpoint_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">setpoint</span><span class="p">)</span>
    <span class="n">Tm_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Tm</span><span class="p">)</span>
    <span class="n">qr_d_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qr_d</span><span class="p">)</span>

    <span class="c1"># move graph with pygame</span>
    <span class="n">win</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">pygame_windows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">left</span> <span class="o">+</span> <span class="mi">420</span><span class="p">,</span> <span class="n">pygame_windows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">top</span> <span class="o">+</span> <span class="mi">50</span><span class="p">)</span>
    <span class="n">win</span><span class="o">.</span><span class="n">showNormal</span><span class="p">()</span>

    <span class="c1"># Draw button</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">rect</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">GREY</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">font</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s2">&quot;INJECT&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">)</span>
    <span class="n">screen</span><span class="o">.</span><span class="n">blit</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">23</span><span class="p">))</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">rect</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">RED</span><span class="p">,</span> <span class="p">(</span><span class="mi">292</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">font</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="s2">&quot;RESET&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
    <span class="n">screen</span><span class="o">.</span><span class="n">blit</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="p">(</span><span class="mi">303</span><span class="p">,</span> <span class="mi">23</span><span class="p">))</span>

    <span class="c1"># Draw disturbance input field</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">rect</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">GREY</span><span class="p">,</span> <span class="p">(</span><span class="mi">110</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">draw</span><span class="o">.</span><span class="n">rect</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">WHITE</span><span class="p">,</span> <span class="p">(</span><span class="mi">125</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">font</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">input_string</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">screen</span><span class="o">.</span><span class="n">blit</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="p">(</span><span class="mi">130</span><span class="p">,</span> <span class="mi">25</span><span class="p">))</span>

    <span class="c1"># calculate FPS and draw</span>
    <span class="n">fps</span> <span class="o">=</span> <span class="n">clock</span><span class="o">.</span><span class="n">get_fps</span><span class="p">()</span>
    <span class="n">timedt</span> <span class="o">+=</span> <span class="n">dt</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">qp</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">setpoint</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">):</span>
        <span class="n">controller_stat_flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">controller_stat_flag</span><span class="p">):</span>
        <span class="n">controller_time</span> <span class="o">+=</span> <span class="n">dt</span>
        <span class="n">controller_energy</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">qr_d</span> <span class="o">*</span> <span class="n">Tm</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>
    <span class="k">if</span><span class="p">(</span><span class="n">controller_mode</span> <span class="o">!=</span> <span class="n">Stabilize_Controller</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">controller_stat_flag_last</span> <span class="ow">and</span> <span class="n">controller_stat_flag</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">qp</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">setpoint</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">)):</span>
        <span class="n">controller_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">controller_energy</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">controller_stat_flag_last</span> <span class="o">=</span> <span class="n">controller_stat_flag</span>
    <span class="k">if</span> <span class="n">fps</span><span class="p">:</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">fps</span>

    <span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">flip</span><span class="p">()</span>
    <span class="n">clock</span><span class="o">.</span><span class="n">tick</span><span class="p">(</span><span class="mi">165</span><span class="p">)</span>

<span class="n">pygame</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
<span class="n">stop_thread</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
An exception has occurred, use %tb to see the full traceback.

<span class="ansi-red-fg">SystemExit</span>

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
C:\Users\Utilizador\AppData\Roaming\Python\Python313\site-packages\IPython\core\interactiveshell.py:3678: UserWarning: To exit: use &#39;exit&#39;, &#39;quit&#39;, or Ctrl-D.
  warn(&#34;To exit: use &#39;exit&#39;, &#39;quit&#39;, or Ctrl-D.&#34;, stacklevel=1)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/project3_sim_simulation_54_2.png" src="../../_images/project3_sim_simulation_54_2.png" />
</div>
</div>
</section>
<section id="Usage">
<h2>Usage<a class="headerlink" href="#Usage" title="Link to this heading"></a></h2>
<p><img alt="Image of the program" src="https://github.com/B-Paweekorn/Reaction-wheel-inverted-pendulum/assets/47713359/e2ff45d4-bfb2-4831-9ec9-334b88f8ff77" /></p>
<p><strong>Inject</strong> - Type the amount of torque into the box and click <code class="docutils literal notranslate"><span class="pre">INJECT</span></code> or ENTER key to inject a disturbance to the system</p>
<p><strong>Reset</strong> - Click <code class="docutils literal notranslate"><span class="pre">RESET</span></code> to reset the system</p>
<p><strong>Plotting</strong> - Click on the pendulum plot or the plot window to plot the data</p>
<p>Edit the parameters in <code class="docutils literal notranslate"><span class="pre">param.py</span></code> (or above)S</p>
</section>
<section id="Example-runs">
<h2>Example runs<a class="headerlink" href="#Example-runs" title="Link to this heading"></a></h2>
</section>
<section id="Export-to-python-script?">
<h2>Export to python script?<a class="headerlink" href="#Export-to-python-script?" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># Physical constants and system parameters</span>
<span class="n">g</span> <span class="o">=</span> <span class="mf">9.81</span>  <span class="c1"># gravity (m/s^2)</span>

<span class="c1"># Pendulum parameters</span>
<span class="n">m_p</span> <span class="o">=</span> <span class="mf">0.2</span>      <span class="c1"># pendulum mass (kg)</span>
<span class="n">l_p</span> <span class="o">=</span> <span class="mf">0.3</span>      <span class="c1"># pendulum length to center of mass (m)</span>
<span class="n">I_p</span> <span class="o">=</span> <span class="n">m_p</span> <span class="o">*</span> <span class="n">l_p</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># simple model of pendulum moment of inertia (kg·m²)</span>

<span class="c1"># Reaction wheel parameters</span>
<span class="n">m_w</span> <span class="o">=</span> <span class="mf">0.05</span>     <span class="c1"># reaction wheel mass (kg)</span>
<span class="n">r_w</span> <span class="o">=</span> <span class="mf">0.05</span>     <span class="c1"># reaction wheel radius (m)</span>
<span class="n">I_w</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">m_w</span> <span class="o">*</span> <span class="n">r_w</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># moment of inertia for solid disk (kg·m²)</span>

<span class="c1"># Motor parameters</span>
<span class="n">V_max</span> <span class="o">=</span> <span class="mi">12</span>       <span class="c1"># max voltage (V)</span>
<span class="n">R</span> <span class="o">=</span> <span class="mf">4.0</span>          <span class="c1"># coil resistance (Ohm)</span>
<span class="n">k_t</span> <span class="o">=</span> <span class="mf">0.05</span>       <span class="c1"># torque constant (Nm/A)</span>
<span class="n">k_e</span> <span class="o">=</span> <span class="mf">0.05</span>       <span class="c1"># back-EMF constant (V·s/rad)</span>

<span class="c1"># Target performance</span>
<span class="n">omega_w_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">V_max</span> <span class="o">/</span> <span class="n">k_e</span><span class="p">)</span>  <span class="c1"># max theoretical speed (rad/s)</span>
<span class="n">E_wheel_max</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">I_w</span> <span class="o">*</span> <span class="n">omega_w_max</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># max energy storable in wheel</span>

<span class="c1"># Energy needed to raise pendulum</span>
<span class="n">E_pendulum</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">m_p</span> <span class="o">*</span> <span class="n">g</span> <span class="o">*</span> <span class="n">l_p</span>  <span class="c1"># from lowest to highest point</span>

<span class="c1"># Max torque at stall (worst-case speed)</span>
<span class="n">I_max</span> <span class="o">=</span> <span class="n">V_max</span> <span class="o">/</span> <span class="n">R</span>
<span class="n">tau_max</span> <span class="o">=</span> <span class="n">k_t</span> <span class="o">*</span> <span class="n">I_max</span>

<span class="c1"># Required angular acceleration</span>
<span class="n">alpha_required</span> <span class="o">=</span> <span class="n">E_pendulum</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">I_p</span><span class="p">)</span>  <span class="c1"># rough estimate</span>

<span class="c1"># Required torque to achieve that acceleration</span>
<span class="n">tau_required</span> <span class="o">=</span> <span class="n">I_p</span> <span class="o">*</span> <span class="n">alpha_required</span>

<span class="c1"># Result summary</span>
<span class="p">{</span>
    <span class="s2">&quot;Pendulum inertia I_p (kg·m²)&quot;</span><span class="p">:</span> <span class="n">I_p</span><span class="p">,</span>
    <span class="s2">&quot;Required energy to raise pendulum (J)&quot;</span><span class="p">:</span> <span class="n">E_pendulum</span><span class="p">,</span>
    <span class="s2">&quot;Max wheel energy (J)&quot;</span><span class="p">:</span> <span class="n">E_wheel_max</span><span class="p">,</span>
    <span class="s2">&quot;Max motor torque (Nm)&quot;</span><span class="p">:</span> <span class="n">tau_max</span><span class="p">,</span>
    <span class="s2">&quot;Required torque (Nm)&quot;</span><span class="p">:</span> <span class="n">tau_required</span><span class="p">,</span>
    <span class="s2">&quot;Swing-up possible?&quot;</span><span class="p">:</span> <span class="n">E_wheel_max</span> <span class="o">&gt;=</span> <span class="n">E_pendulum</span> <span class="ow">and</span> <span class="n">tau_max</span> <span class="o">&gt;=</span> <span class="n">tau_required</span>
<span class="p">}</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;Pendulum inertia I_p (kg·m²)&#39;: 0.018,
 &#39;Required energy to raise pendulum (J)&#39;: 1.1772,
 &#39;Max wheel energy (J)&#39;: 1.8000000000000005,
 &#39;Max motor torque (Nm)&#39;: 0.15000000000000002,
 &#39;Required torque (Nm)&#39;: 0.3747143980155584,
 &#39;Swing-up possible?&#39;: False}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># Constants (adjustable for analysis)</span>
<span class="n">m_p</span> <span class="o">=</span> <span class="mf">0.3</span>     <span class="c1"># Pendulum mass (kg)</span>
<span class="n">l_p</span> <span class="o">=</span> <span class="mf">0.3</span>     <span class="c1"># Pendulum length (m)</span>
<span class="n">g</span> <span class="o">=</span> <span class="mf">9.81</span>      <span class="c1"># Gravitational acceleration (m/s²)</span>
<span class="n">I_p</span> <span class="o">=</span> <span class="n">m_p</span> <span class="o">*</span> <span class="n">l_p</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># Approximate moment of inertia of pendulum (point mass)</span>
<span class="n">theta_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>   <span class="c1"># Upright position relative to down</span>

<span class="c1"># Energy needed to lift pendulum from down to up</span>
<span class="n">E_required</span> <span class="o">=</span> <span class="n">m_p</span> <span class="o">*</span> <span class="n">g</span> <span class="o">*</span> <span class="n">l_p</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_max</span><span class="p">))</span>

<span class="c1"># Parameter sweep</span>
<span class="n">I_wheel_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1e-4</span><span class="p">,</span> <span class="mf">2e-2</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>  <span class="c1"># Moment of inertia of wheel (kg·m²)</span>
<span class="n">omega_max_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>   <span class="c1"># Max angular velocity of wheel (rad/s)</span>

<span class="n">I_w</span><span class="p">,</span> <span class="n">omega_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">I_wheel_range</span><span class="p">,</span> <span class="n">omega_max_range</span><span class="p">)</span>

<span class="c1"># Kinetic energy of the wheel: E = 1/2 * I * omega²</span>
<span class="n">E_wheel</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">I_w</span> <span class="o">*</span> <span class="n">omega_w</span><span class="o">**</span><span class="mi">2</span>

<span class="c1"># Feasibility mask</span>
<span class="n">feasible</span> <span class="o">=</span> <span class="n">E_wheel</span> <span class="o">&gt;=</span> <span class="n">E_required</span>

<span class="c1"># Plotting</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">cp</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">I_w</span><span class="p">,</span> <span class="n">omega_w</span><span class="p">,</span> <span class="n">feasible</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;salmon&#39;</span><span class="p">,</span> <span class="s1">&#39;lightgreen&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Feasibility (1 = feasible)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">I_w</span><span class="p">,</span> <span class="n">omega_w</span><span class="p">,</span> <span class="n">E_wheel</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="n">E_required</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Wheel Moment of Inertia $I_w$ (kg·m²)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Max Angular Velocity $</span><span class="se">\\</span><span class="s2">omega_</span><span class="si">{max}</span><span class="s2">$ (rad/s)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Feasibility of Reaction Wheel Energy for Pendulum Swing-Up&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/project3_sim_simulation_61_0.png" src="../../_images/project3_sim_simulation_61_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># Constants</span>
<span class="n">g</span> <span class="o">=</span> <span class="mf">9.81</span>  <span class="c1"># gravity [m/s^2]</span>

<span class="c1"># Pendulum parameters (design variables)</span>
<span class="n">m_p</span> <span class="o">=</span> <span class="mf">0.2</span>     <span class="c1"># pendulum mass [kg]</span>
<span class="n">L_p</span> <span class="o">=</span> <span class="mf">0.25</span>    <span class="c1"># pendulum length (pivot to CoM) [m]</span>
<span class="n">I_p</span> <span class="o">=</span> <span class="n">m_p</span> <span class="o">*</span> <span class="n">L_p</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># approximate moment of inertia for point mass at distance L</span>

<span class="c1"># Required potential energy to reach upright position</span>
<span class="n">E_required</span> <span class="o">=</span> <span class="n">m_p</span> <span class="o">*</span> <span class="n">g</span> <span class="o">*</span> <span class="n">L_p</span>  <span class="c1"># [J]</span>

<span class="c1"># Reaction wheel parameters (design variables)</span>
<span class="n">I_w_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>     <span class="c1"># wheel moment of inertia [kg·m²]</span>
<span class="n">omega_max_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>  <span class="c1"># max angular velocity [rad/s]</span>
<span class="n">I_w_grid</span><span class="p">,</span> <span class="n">omega_max_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">I_w_range</span><span class="p">,</span> <span class="n">omega_max_range</span><span class="p">)</span>

<span class="c1"># Wheel kinetic energy</span>
<span class="n">E_kin_wheel</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">I_w_grid</span> <span class="o">*</span> <span class="n">omega_max_grid</span><span class="o">**</span><span class="mi">2</span>

<span class="c1"># Damping and swing-up time effects (additional margin)</span>
<span class="n">swing_up_time</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># [s] desired swing-up time</span>
<span class="n">damping_coeff</span> <span class="o">=</span> <span class="mf">0.01</span>  <span class="c1"># [N·m·s] total viscous damping</span>

<span class="c1"># Energy loss estimate during swing-up</span>
<span class="n">E_loss_damping</span> <span class="o">=</span> <span class="n">damping_coeff</span> <span class="o">*</span> <span class="p">(</span><span class="n">omega_max_grid</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">swing_up_time</span>

<span class="c1"># Feasibility condition: kinetic energy must exceed potential + losses</span>
<span class="n">feasible</span> <span class="o">=</span> <span class="n">E_kin_wheel</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">E_required</span> <span class="o">+</span> <span class="n">E_loss_damping</span><span class="p">)</span>

<span class="c1"># Plotting</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">cp</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">I_w_grid</span><span class="p">,</span> <span class="n">omega_max_grid</span><span class="p">,</span> <span class="n">feasible</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Feasibility (0: No, 1: Yes)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">I_w_grid</span><span class="p">,</span> <span class="n">omega_max_grid</span><span class="p">,</span> <span class="n">E_kin_wheel</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Wheel Inertia $I_w$ [kg·m²]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Max Wheel Speed $</span><span class="se">\\</span><span class="s2">omega_{</span><span class="se">\\</span><span class="s2">mathrm</span><span class="si">{max}</span><span class="s2">}$ [rad/s]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Feasibility Region for Reaction Wheel Swing-Up&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/project3_sim_simulation_62_0.png" src="../../_images/project3_sim_simulation_62_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-intense-fg ansi-bold">The Kernel crashed while executing code in the current cell or a previous cell.

</span><span class="ansi-red-intense-fg ansi-bold">Please review the code in the cell(s) to identify a possible cause of the failure.

</span><span class="ansi-red-intense-fg ansi-bold">Click &lt;a href=&#39;https://aka.ms/vscodeJupyterKernelCrash&#39;&gt;here&lt;/a&gt; for more info.

</span><span class="ansi-red-intense-fg ansi-bold">View Jupyter &lt;a href=&#39;command:jupyter.viewOutput&#39;&gt;log&lt;/a&gt; for further details.</span>
</pre></div></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, mniehus.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>